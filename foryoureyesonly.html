<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUT Clinic Management System Prototype</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://placehold.co/1920x1080/E0F2F7/333333?text=Clinic+Background'); /* Placeholder for clinic_main_background.png */
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1 0 auto;
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white background for content */
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .card-img-top-icon {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid #eee;
        }

        .card {
            transition: transform .2s ease-out, box-shadow .2s ease-out;
        }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
            }

        .chat-container {
            display: flex;
            height: 75vh;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .contacts-list {
            flex: 0 0 280px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .contact {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

            .contact:hover, .contact.active {
                background-color: #f0f2f5;
            }

        .chat-window {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }

        .messages-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        .message {
            margin-bottom: 15px;
        }

            .message .sender-name {
                font-weight: bold;
                font-size: 0.9em;
                color: #555;
            }

            .message .message-content {
                padding: 10px 15px;
                border-radius: 18px;
                display: inline-block;
                max-width: 70%;
            }

            .message.sent .message-content {
                background-color: #3B82F6; /* Tailwind blue-500 */
                color: white;
            }

            .message.sent {
                text-align: right;
            }

            .message.received .message-content {
                background-color: #E5E7EB; /* Tailwind gray-200 */
                color: #333;
            }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
        }

        /* Custom Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

            .close-button:hover,
            .close-button:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }
        /* Assign Staff Modal specific styles */
        #assignStaffModal .modal-content {
            max-width: 600px;
        }

        #assignStaffModal label {
            text-align: left;
            display: block;
            margin-bottom: 0.5rem;
        }

        #assignStaffModal select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Custom Modals -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold text-gray-800"></p>
            <button onclick="closeModal()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">OK</button>
        </div>
    </div>

    <div id="assignStaffModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeAssignStaffModal()">&times;</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Assign Staff to Appointment</h3>
            <form id="assignStaffForm">
                <input type="hidden" id="assignAppointmentId">
                <p class="mb-4 text-lg font-semibold">Appointment ID: <span id="assignAppointmentDisplayId" class="text-blue-700"></span></p>
                <div class="mb-4">
                    <label for="assignDoctorSelect" class="block text-gray-700 text-sm font-bold mb-2">Assign Doctor:</label>
                    <select id="assignDoctorSelect" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">-- Select Doctor (Optional) --</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="assignNurseSelect" class="block text-gray-700 text-sm font-bold mb-2">Assign Nurse:</label>
                    <select id="assignNurseSelect" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">-- Select Nurse (Optional) --</option>
                    </select>
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button type="submit" class="btn-primary">Assign Staff</button>
                    <button type="button" class="btn-secondary" onclick="closeAssignStaffModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW/MODIFIED SECTION -->
    <div id="confirmDeliveryModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeConfirmDeliveryModal()">&times;</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Confirm Delivery</h3>
            <form id="confirmDeliveryForm">
                <input type="hidden" id="confirmDeliveryId">
                <p class="mb-4 text-lg">Enter the 6-digit OTP provided by the patient to confirm delivery for request <strong id="confirmDeliveryDisplayId" class="text-blue-700"></strong>.</p>
                <div class="mb-4">
                    <label for="deliveryOtp" class="block text-gray-700 text-sm font-bold mb-2">One-Time Password (OTP):</label>
                    <input type="text" id="deliveryOtp" name="otp" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center text-2xl tracking-widest" maxlength="6" required>
                </div>
                <div class="flex justify-center space-x-4 mt-6">
                    <button type="submit" class="btn-primary">Confirm Delivery</button>
                    <button type="button" class="btn-secondary" onclick="closeConfirmDeliveryModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    <!-- END NEW/MODIFIED SECTION -->

    <nav class="bg-white shadow-md py-4">
        <div class="container mx-auto flex justify-between items-center px-4">
            <a href="#" class="flex items-center space-x-2 text-blue-700 font-bold text-xl">
                <img src="https://placehold.co/40x40/CCCCCC/FFFFFF?text=Logo" alt="DUT Clinic Logo" class="rounded-full">
                <span>DUT Clinic</span>
            </a>
            <div class="flex items-center space-x-4">
                <select id="userRoleSelect" class="p-2 border border-gray-300 rounded-md">
                    <option value="Guest">Guest</option>
                    <option value="Student">Student</option>
                    <option value="Doctor">Doctor</option>
                    <option value="Pharmacist">Pharmacist</option>
                    <option value="Receptionist">Receptionist</option>
                    <option value="Nurse">Nurse</option>
                    <option value="Admin">Admin</option>
                    <!-- NEW/MODIFIED SECTION -->
                    <option value="DeliveryDriver">Delivery Driver</option>
                    <!-- END NEW/MODIFIED SECTION -->
                </select>
                <div id="nav-links" class="hidden md:flex space-x-6">
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="home">Home</a>
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="book-appointment" data-roles="Student">Book Appointment</a>
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="my-appointments" data-roles="Student">My Appointments</a>
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="my-delivery-requests" data-roles="Student">My Deliveries</a>
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="submit-feedback" data-roles="Student">Submit Feedback</a>
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="request-emergency-services" data-roles="Student">Emergency</a>
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="chat" data-roles="Student,Doctor,Pharmacist,Receptionist,Nurse,Admin,DeliveryDriver">Chat</a>
                    <!-- Admin specific links -->
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="admin-dashboard" data-roles="Admin">Admin Dashboard</a>
                    <!-- Doctor specific links -->
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="doctor-dashboard" data-roles="Doctor">Doctor Dashboard</a>
                    <!-- Pharmacist specific links -->
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="pharmacist-dashboard" data-roles="Pharmacist">Pharmacist Dashboard</a>
                    <!-- Receptionist specific links -->
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="receptionist-dashboard" data-roles="Receptionist">Receptionist Dashboard</a>
                    <!-- Nurse specific links -->
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="nurse-dashboard" data-roles="Nurse">Nurse Dashboard</a>
                    <!-- NEW/MODIFIED SECTION -->
                    <!-- Delivery Driver specific links -->
                    <a href="#" class="nav-link text-gray-700 hover:text-blue-500 font-medium" data-target="delivery-driver-dashboard" data-roles="DeliveryDriver">Delivery Dashboard</a>
                    <!-- END NEW/MODIFIED SECTION -->
                </div>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 main-content">
        <!-- Home Section -->
        <section id="home" class="content-section active">
            <div class="text-center py-5">
                <div class="inline-block p-10 rounded-xl shadow-lg bg-white bg-opacity-85">
                    <img src="https://placehold.co/140x100/CCCCCC/FFFFFF?text=DUT+Logo" alt="DUT Clinic Logo" class="max-w-xs mx-auto mb-6 rounded-lg">
                    <h1 class="text-5xl font-extrabold text-blue-700 mb-4">Welcome to the DUT Clinic</h1>
                    <p class="text-2xl text-gray-600 mb-6">Your Health, Our Priority.</p>
                    <hr class="my-6 mx-auto w-20 border-t-4 border-blue-600">
                    <p class="text-lg leading-relaxed mb-8">
                        Access quality healthcare services with ease. <br>
                        Book appointments, consult with our medical professionals virtually or in-person, <br>
                        manage your medical records, and request medication deliveries all in one place.
                    </p>
                    <div class="mt-8">
                        <button class="btn-primary px-8 py-3 text-xl mr-4" onclick="showSection('book-appointment')">Book Appointment</button>
                        <button class="btn-secondary px-8 py-3 text-xl" onclick="showSection('my-appointments')">My Appointments</button>
                    </div>
                </div>
            </div>

            <div class="container mx-auto py-5">
                <h2 class="text-center mb-10 text-4xl font-light">Our Core Services</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="card bg-white rounded-xl shadow-lg border border-gray-200">
                        <div class="p-6 text-center">
                            <img src="https://placehold.co/100x100/0D6EFD/FFFFFF?text=Appointments" class="card-img-top-icon mx-auto mt-4" alt="Book Appointments">
                            <h5 class="text-2xl font-bold mt-4 mb-2">Book Appointments</h5>
                            <p class="text-gray-700">Easily schedule your visits with our healthcare professionals online at your convenience.</p>
                            <div class="mt-6">
                                <button class="btn-outline-primary" onclick="showSection('book-appointment')">Schedule Now</button>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-white rounded-xl shadow-lg border border-gray-200">
                        <div class="p-6 text-center">
                            <img src="https://placehold.co/100x100/198754/FFFFFF?text=Virtual" class="card-img-top-icon mx-auto mt-4" alt="Virtual Consultations">
                            <h5 class="text-2xl font-bold mt-4 mb-2">Virtual Consultations</h5>
                            <p class="text-gray-700">Access quality healthcare from the comfort of your home via secure video calls.</p>
                            <div class="mt-6">
                                <button class="btn-outline-success" onclick="showModal('Virtual Consultations feature coming soon!')">Learn More</button>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-white rounded-xl shadow-lg border border-gray-200">
                        <div class="p-6 text-center">
                            <img src="https://placehold.co/100x100/FFC107/000000?text=Delivery" class="card-img-top-icon mx-auto mt-4" alt="Medication Delivery">
                            <h5 class="text-2xl font-bold mt-4 mb-2">Medication Delivery</h5>
                            <p class="text-gray-700">Get your prescribed medications delivered conveniently and safely to your doorstep.</p>
                            <div class="mt-6">
                                <button class="btn-outline-warning" onclick="showSection('my-delivery-requests')">Request Now</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Student Dashboard (Simplified) -->
        <section id="student-dashboard" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Student Dashboard</h2>
            <p class="text-lg text-gray-700 mb-4">Welcome, Student! Here you can manage your appointments and health records.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">Book an Appointment</h3>
                    <p class="text-blue-700 mb-4">Schedule a new consultation with a doctor or nurse.</p>
                    <button class="btn-primary" onclick="showSection('book-appointment')">Book Now</button>
                </div>
                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-green-800 mb-2">View My Appointments</h3>
                    <p class="text-green-700 mb-4">Check your upcoming and past appointments.</p>
                    <button class="btn-success" onclick="showSection('my-appointments')">View Appointments</button>
                </div>
                <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-2">My Delivery Requests</h3>
                    <p class="text-yellow-700 mb-4">Track your medication delivery requests.</p>
                    <button class="btn-warning" onclick="showSection('my-delivery-requests')">View Deliveries</button>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-purple-800 mb-2">Submit Feedback</h3>
                    <p class="text-purple-700 mb-4">Provide feedback on your recent clinic visits.</p>
                    <button class="btn-indigo" onclick="showSection('submit-feedback')">Give Feedback</button>
                </div>
                <div class="bg-red-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-red-800 mb-2">Request Emergency</h3>
                    <p class="text-red-700 mb-4">Request immediate ambulance or emergency services.</p>
                    <button class="btn-danger" onclick="showSection('request-emergency-services')">Emergency</button>
                </div>
                <div class="bg-gray-200 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Chat with Staff</h3>
                    <p class="text-gray-700 mb-4">Communicate directly with clinic staff.</p>
                    <button class="btn-gray" onclick="showSection('chat')">Start Chat</button>
                </div>
            </div>
        </section>

        <!-- Book Appointment Section -->
        <section id="book-appointment" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Book New Appointment</h2>
            <p class="text-lg text-gray-700 mb-4">Please select your preferred date, time, and reason for your visit.</p>
            <hr class="mb-6">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200">
                <form id="bookAppointmentForm">
                    <div class="mb-4">
                        <label for="appointmentDateTime" class="block text-gray-700 text-sm font-bold mb-2">Appointment Date & Time:</label>
                        <input type="datetime-local" id="appointmentDateTime" name="appointmentDateTime" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>

                    <div class="mb-4">
                        <label for="reasonForVisit" class="block text-gray-700 text-sm font-bold mb-2">Reason for Visit:</label>
                        <textarea id="reasonForVisit" name="reasonForVisit" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" rows="3" required></textarea>
                    </div>

                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="isVirtualCheckbox" name="isVirtual" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <label for="isVirtualCheckbox" class="ml-2 text-gray-700">Virtual Appointment</label>
                    </div>

                    <div id="virtualAppointmentFields" class="mb-4 hidden">
                        <label for="platform" class="block text-gray-700 text-sm font-bold mb-2">Platform:</label>
                        <select id="platform" name="platform" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">-- Select Platform --</option>
                            <option value="Teams">Microsoft Teams</option>
                            <option value="Zoom">Zoom</option>
                            <option value="GoogleMeet">Google Meet</option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between mt-6">
                        <button type="submit" class="btn-primary">Request Appointment</button>
                        <button type="button" class="btn-secondary" onclick="showSection('student-dashboard')">Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- My Appointments Section -->
        <section id="my-appointments" class="content-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">My Appointments</h2>
                <button class="btn-primary flex items-center space-x-2" onclick="showSection('book-appointment')">
                    <i class="fas fa-plus"></i>
                    <span>Book New Appointment</span>
                </button>
            </div>

            <div id="appointment-messages" class="mb-4"></div>

            <div class="flex space-x-4 mb-6">
                <button class="tab-button px-4 py-2 rounded-md font-medium" data-filter="upcoming">Upcoming</button>
                <button class="tab-button px-4 py-2 rounded-md font-medium" data-filter="past">Past</button>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div id="appointments-list">
                    <p class="text-center text-gray-600 p-4">You have no appointments.</p>
                </div>
            </div>
        </section>

        <!-- My Delivery Requests Section -->
        <section id="my-delivery-requests" class="content-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">My Delivery Requests</h2>
                <button class="btn-primary flex items-center space-x-2" onclick="showSection('request-prescription-delivery')">
                    <i class="fas fa-plus"></i>
                    <span>Request New Delivery</span>
                </button>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div id="delivery-requests-list">
                    <p class="text-center text-gray-600 p-4">You have no delivery requests.</p>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button class="btn-secondary" onclick="showSection('student-dashboard')">Back to Dashboard</button>
            </div>
        </section>

        <!-- Request Prescription Delivery Section -->
        <section id="request-prescription-delivery" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Request Prescription Delivery</h2>
            <p class="text-lg text-gray-700 mb-4">Select a ready prescription and provide delivery details.</p>
            <hr class="mb-6">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200">
                <form id="requestDeliveryForm">
                    <div class="mb-4">
                        <label for="prescriptionToDeliver" class="block text-gray-700 text-sm font-bold mb-2">Prescription to Deliver:</label>
                        <select id="prescriptionToDeliver" name="prescriptionId" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="">-- Select Prescription --</option>
                            <!-- Ready for collection prescriptions will be populated here -->
                        </select>
                        <p id="noPrescriptionsMessage" class="text-sm text-red-500 mt-2 hidden">No prescriptions ready for delivery. Please check with the pharmacist.</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Delivery Type:</label>
                        <div class="flex items-center space-x-4">
                            <input type="radio" id="deliveryTypeDUT" name="deliveryType" value="DUT" class="form-radio h-4 w-4 text-blue-600" checked>
                            <label for="deliveryTypeDUT" class="ml-2 text-gray-700">DUT Residence</label>
                            <input type="radio" id="deliveryTypeOther" name="deliveryType" value="Other" class="form-radio h-4 w-4 text-blue-600">
                            <label for="deliveryTypeOther" class="ml-2 text-gray-700">Other Address (Paid)</label>
                        </div>
                    </div>

                    <div id="dutResidenceFields" class="mb-4">
                        <label for="dutResidenceSelect" class="block text-gray-700 text-sm font-bold mb-2">Select DUT Residence:</label>
                        <select id="dutResidenceSelect" name="dutResidence" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">-- Select Residence --</option>
                        </select>
                        <p id="noDUTResidencesMessage" class="text-sm text-red-500 mt-2 hidden">No DUT Residences available.</p>
                    </div>

                    <div id="otherAddressFields" class="mb-4 hidden">
                        <label for="manualDeliveryAddress" class="block text-gray-700 text-sm font-bold mb-2">Full Delivery Address:</label>
                        <textarea id="manualDeliveryAddress" name="manualDeliveryAddress" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" rows="3"></textarea>
                    </div>

                    <div class="mb-4">
                        <label for="contactNumber" class="block text-gray-700 text-sm font-bold mb-2">Contact Number:</label>
                        <input type="tel" id="contactNumber" name="contactNumber" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., 0812345678" required>
                    </div>

                    <div id="paymentGateway" class="mb-4 p-4 bg-gray-100 rounded-lg hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Payment Required</h3>
                        <p class="text-lg text-gray-700 mb-2">Delivery Fee: R <span id="deliveryFeeAmount">50.00</span></p>
                        <button type="button" class="btn-primary" onclick="simulatePayment()">Simulate Payment</button>
                        <p id="paymentStatus" class="text-sm text-green-600 mt-2 hidden">Payment successful!</p>
                    </div>

                    <div class="flex items-center justify-between mt-6">
                        <button type="submit" class="btn-primary" id="submitDeliveryRequestBtn">Submit Delivery Request</button>
                        <button type="button" class="btn-secondary" onclick="showSection('my-delivery-requests')">Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Submit Feedback Section -->
        <section id="submit-feedback" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Submit Post-Visit Feedback</h2>
            <p class="text-lg text-gray-700 mb-4">We value your opinion! Please provide feedback on a completed appointment.</p>
            <hr class="mb-6">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200">
                <form id="feedbackForm">
                    <div class="mb-4">
                        <label for="feedbackAppointmentId" class="block text-gray-700 text-sm font-bold mb-2">Select Completed Appointment:</label>
                        <select id="feedbackAppointmentId" name="appointmentId" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="">-- Select Appointment --</option>
                            <!-- Completed appointments without feedback will be populated here -->
                        </select>
                        <p id="noFeedbackAppointmentsMessage" class="text-sm text-red-500 mt-2 hidden">No completed appointments awaiting feedback.</p>
                    </div>

                    <div class="mb-4">
                        <label for="feedbackRating" class="block text-gray-700 text-sm font-bold mb-2">Overall Rating (1-5 Stars):</label>
                        <select id="feedbackRating" name="rating" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="">-- Select Rating --</option>
                            <option value="5">5 - Excellent</option>
                            <option value="4">4 - Very Good</option>
                            <option value="3">3 - Good</option>
                            <option value="2">2 - Fair</option>
                            <option value="1">1 - Poor</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="feedbackComments" class="block text-gray-700 text-sm font-bold mb-2">Comments (Optional):</label>
                        <textarea id="feedbackComments" name="comments" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" rows="3"></textarea>
                    </div>

                    <p class="text-sm text-gray-600 mb-6 italic">Your feedback is important to us and will be submitted anonymously to help us improve our services.</p>

                    <div class="flex items-center justify-between mt-6">
                        <button type="submit" class="btn-primary">Submit Feedback</button>
                        <button type="button" class="btn-secondary" onclick="showSection('student-dashboard')">Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Request Emergency Services Section -->
        <section id="request-emergency-services" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Request Emergency Services</h2>
            <p class="text-lg text-gray-700 mb-4">If you are experiencing a medical emergency, please confirm your details to dispatch an ambulance.</p>
            <hr class="mb-6">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200">
                <form id="emergencyRequestForm">
                    <input type="hidden" id="emergencyStudentId">
                    <p class="mb-4 text-lg font-semibold">Confirming Emergency for: <span id="emergencyStudentName" class="text-blue-700"></span></p>

                    <div class="mb-4">
                        <label for="emergencyLocation" class="block text-gray-700 text-sm font-bold mb-2">Current Location/Address:</label>
                        <input type="text" id="emergencyLocation" name="location" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., DUT Residence A, Room 101" required>
                    </div>
                    <div class="mb-4">
                        <label for="emergencyDescription" class="block text-gray-700 text-sm font-bold mb-2">Brief Description of Emergency:</label>
                        <textarea id="emergencyDescription" name="description" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" rows="3" placeholder="e.g., Severe chest pain, unconscious, bleeding heavily" required></textarea>
                    </div>
                    <p class="text-sm text-red-600 mb-6">By clicking "Confirm Request", an ambulance will be dispatched to your location and your emergency contacts will be notified.</p>
                    <div class="flex items-center justify-between mt-6">
                        <button type="submit" class="btn-danger flex items-center space-x-2">
                            <i class="fas fa-ambulance"></i>
                            <span>Confirm Request</span>
                        </button>
                        <button type="button" class="btn-secondary" onclick="showSection('student-dashboard')">Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chat" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Instant Messaging</h2>
            <p class="text-lg text-gray-700 mb-4">Communicate instantly with other clinic users. Select a contact from the left to start a conversation. Messages are saved in your browser and will appear when you select the same contact again.</p>
            <hr class="mb-6">

            <div class="chat-container bg-white rounded-lg shadow-md">
                <div class="contacts-list p-4">
                    <h3 class="text-xl font-semibold mb-4">Contacts</h3>
                    <div id="contactList">
                        <!-- Contacts will be dynamically loaded here -->
                    </div>
                </div>
                <div class="chat-window">
                    <div id="chatHeader" class="chat-header bg-gray-100 text-gray-800">Select a contact to start messaging</div>
                    <div id="messagesArea" class="messages-area">
                        <!-- Messages will be loaded here -->
                    </div>
                    <div class="chat-input-area bg-gray-50">
                        <input type="text" id="messageInput" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type a message..." disabled />
                        <button id="sendButton" class="ml-3 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Send</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Simulated Admin Dashboard -->
        <section id="admin-dashboard" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Admin Dashboard (Simulated)</h2>
            <p class="text-lg text-gray-700">Welcome, Admin! This is a placeholder for administrative tasks.</p>
            <ul class="list-disc list-inside mt-4 text-gray-700">
                <li>Manage Users</li>
                <li>View System Logs</li>
                <li>Configure Settings</li>
            </ul>
        </section>

        <!-- Doctor Dashboard -->
        <section id="doctor-dashboard" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Doctor Dashboard</h2>
            <p class="text-lg text-gray-700 mb-4">Welcome, Doctor! Here you can manage your consultations and patient records.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">My Assigned Appointments</h3>
                    <p class="text-blue-700 mb-4">View appointments assigned to you and start consultations.</p>
                    <button class="btn-primary" onclick="showSection('my-assigned-appointments-doctor')">View Appointments</button>
                </div>
                <div class="bg-red-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-red-800 mb-2">Issue Medical Certificate</h3>
                    <p class="text-red-700 mb-4">Generate medical certificates for patients.</p>
                    <button class="btn-danger" onclick="showSection('issue-medical-certificate')">Issue Certificate</button>
                </div>
                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-green-800 mb-2">Schedule Follow-Up</h3>
                    <p class="text-green-700 mb-4">Schedule a follow-up appointment for a patient.</p>
                    <button class="btn-success" onclick="showSection('schedule-follow-up')">Schedule Follow-Up</button>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-purple-800 mb-2">Chat with Staff</h3>
                    <p class="text-purple-700 mb-4">Communicate directly with clinic staff.</p>
                    <button class="btn-indigo" onclick="showSection('chat')">Start Chat</button>
                </div>
            </div>
        </section>

        <!-- My Assigned Appointments (Doctor) Section -->
        <section id="my-assigned-appointments-doctor" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">My Assigned Appointments</h2>
            <p class="text-lg text-gray-700 mb-4">Here are the appointments assigned to you.</p>
            <hr class="mb-6">
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div id="doctor-appointments-list">
                    <p class="text-center text-gray-600 p-4">No appointments assigned to you.</p>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button class="btn-secondary" onclick="showSection('doctor-dashboard')">Back to Dashboard</button>
            </div>
        </section>

        <!-- Start Consultation Section (Doctor) -->
        <section id="start-consultation" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Start Consultation</h2>
            <p class="text-lg text-gray-700 mb-4">Record consultation details and prescribe medications.</p>
            <hr class="mb-6">
            <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200">
                <form id="consultationForm">
                    <input type="hidden" id="consultationAppointmentId" name="appointmentId">
                    <input type="hidden" id="consultationPatientId" name="patientId">
                    <p class="mb-4 text-lg font-semibold">Patient: <span id="consultationPatientName" class="text-blue-700"></span></p>

                    <div class="mb-4">
                        <label for="medicalHistoryNotes" class="block text-gray-700 text-sm font-bold mb-2">Medical History/Notes:</label>
                        <textarea id="medicalHistoryNotes" name="medicalHistoryNotes" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32" rows="4" required></textarea>
                    </div>

                    <div class="mb-4">
                        <label for="diagnosis" class="block text-gray-700 text-sm font-bold mb-2">Diagnosis:</label>
                        <textarea id="diagnosis" name="diagnosis" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" rows="3" required></textarea>
                    </div>

                    <h3 class="text-xl font-bold text-gray-800 mb-4 mt-6">Prescribe Medications</h3>
                    <div id="medication-inputs-container">
                        <!-- Dynamic medication input fields will be added here -->
                        <div class="flex items-end space-x-2 mb-3 medication-item">
                            <div class="flex-grow">
                                <label for="medicationSelect_0" class="block text-gray-700 text-sm font-bold mb-1">Medication:</label>
                                <select id="medicationSelect_0" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline medication-select">
                                    <option value="">Select Medication</option>
                                </select>
                            </div>
                            <div>
                                <label for="medicationQuantity_0" class="block text-gray-700 text-sm font-bold mb-1">Quantity:</label>
                                <input type="number" id="medicationQuantity_0" class="shadow border rounded w-24 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline medication-quantity" min="1" value="1">
                            </div>
                            <button type="button" class="btn-danger-sm" onclick="removeMedicationInput(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn-outline-primary mt-2" onclick="addMedicationInput()">Add Another Medication</button>

                    <div class="flex items-center justify-between mt-8">
                        <button type="submit" class="btn-primary">Complete Consultation</button>
                        <button type="button" class="btn-secondary" onclick="showSection('my-assigned-appointments-doctor')">Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Issue Medical Certificate Section -->
        <section id="issue-medical-certificate" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Issue Medical Certificate</h2>
            <p class="text-lg text-gray-700 mb-4">Generate a medical certificate for a student.</p>
            <hr class="mb-6">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200">
                <form id="medicalCertificateForm">
                    <div class="mb-4">
                        <label for="certificateStudentId" class="block text-gray-700 text-sm font-bold mb-2">Student ID:</label>
                        <input type="text" id="certificateStudentId" name="studentId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., student-1" required>
                    </div>
                    <div class="mb-4">
                        <label for="certificateReason" class="block text-gray-700 text-sm font-bold mb-2">Reason for Certificate:</label>
                        <textarea id="certificateReason" name="reason" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" rows="3" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="certificateStartDate" class="block text-gray-700 text-sm font-bold mb-2">Start Date:</label>
                        <input type="date" id="certificateStartDate" name="startDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-4">
                        <label for="certificateEndDate" class="block text-gray-700 text-sm font-bold mb-2">End Date:</label>
                        <input type="date" id="certificateEndDate" name="endDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button type="submit" class="btn-primary">Generate Certificate</button>
                        <button type="button" class="btn-secondary" onclick="showSection('doctor-dashboard')">Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Schedule Follow Up Section -->
        <section id="schedule-follow-up" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Schedule Follow-Up Consultation</h2>
            <p class="text-lg text-gray-700 mb-4">Schedule a follow-up appointment for a patient with a chronic condition.</p>
            <hr class="mb-6">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200">
                <form id="scheduleFollowUpForm">
                    <div class="mb-4">
                        <label for="followUpPatientId" class="block text-gray-700 text-sm font-bold mb-2">Patient (Chronic Condition):</label>
                        <select id="followUpPatientId" name="patientId" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="">-- Select Patient --</option>
                            <!-- Only students with chronic conditions will be populated here -->
                        </select>
                        <p id="noChronicPatientsMessage" class="text-sm text-red-500 mt-2 hidden">No patients with chronic conditions found.</p>
                    </div>
                    <div class="mb-4">
                        <label for="followUpDateTime" class="block text-gray-700 text-sm font-bold mb-2">Follow-up Date & Time:</label>
                        <input type="datetime-local" id="followUpDateTime" name="appointmentDateTime" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-4">
                        <label for="followUpReason" class="block text-gray-700 text-sm font-bold mb-2">Reason for Follow-up:</label>
                        <textarea id="followUpReason" name="reasonForVisit" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" rows="3" required>Routine follow-up for chronic condition.</textarea>
                    </div>
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="followUpIsVirtual" name="isVirtual" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <label for="followUpIsVirtual" class="ml-2 text-gray-700">Virtual Appointment</label>
                    </div>
                    <div id="followUpVirtualFields" class="mb-4 hidden">
                        <label for="followUpPlatform" class="block text-gray-700 text-sm font-bold mb-2">Platform:</label>
                        <select id="followUpPlatform" name="platform" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">-- Select Platform --</option>
                            <option value="Teams">Microsoft Teams</option>
                            <option value="Zoom">Zoom</option>
                            <option value="GoogleMeet">Google Meet</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button type="submit" class="btn-primary">Schedule Follow-Up</button>
                        <button type="button" class="btn-secondary" onclick="showSection('doctor-dashboard')">Cancel</button>
                    </div>
                </form>
            </div>
        </section>


        <!-- Pharmacist Dashboard -->
        <section id="pharmacist-dashboard" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Pharmacist Dashboard</h2>
            <p class="text-lg text-gray-700 mb-4">Welcome, Pharmacist! Here you can manage medications and process prescriptions.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-2">Manage Medications</h3>
                    <p class="text-yellow-700 mb-4">View, add, and edit clinic medication stock.</p>
                    <button class="btn-warning" onclick="showSection('list-medications')">Go to Medications</button>
                </div>
                <div class="bg-orange-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-orange-800 mb-2">Process Prescriptions</h3>
                    <p class="text-orange-700 mb-4">Review and fulfill pending prescriptions.</p>
                    <button class="btn-orange" onclick="showSection('view-pending-prescriptions')">View Pending</button>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-purple-800 mb-2">Chat with Staff</h3>
                    <p class="text-purple-700 mb-4">Communicate directly with clinic staff.</p>
                    <button class="btn-indigo" onclick="showSection('chat')">Start Chat</button>
                </div>
            </div>
        </section>

        <!-- List Medications Section -->
        <section id="list-medications" class="content-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Clinic Medications</h2>
                <button class="btn-primary flex items-center space-x-2" onclick="showSection('create-medication')">
                    <i class="fas fa-plus"></i>
                    <span>Add New Medication</span>
                </button>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div id="medications-list">
                    <p class="text-center text-gray-600 p-4">No medications in stock.</p>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button class="btn-secondary" onclick="showSection('pharmacist-dashboard')">Back to Dashboard</button>
            </div>
        </section>

        <!-- Create Medication Section -->
        <section id="create-medication" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Add New Medication</h2>
            <hr class="mb-6">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200">
                <form id="createMedicationForm">
                    <div class="mb-4">
                        <label for="medicationName" class="block text-gray-700 text-sm font-bold mb-2">Medication Name:</label>
                        <input type="text" id="medicationName" name="medicationName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-4">
                        <label for="dosage" class="block text-gray-700 text-sm font-bold mb-2">Dosage (e.g., 500mg, 10ml):</label>
                        <input type="text" id="dosage" name="dosage" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-4">
                        <label for="stockQuantity" class="block text-gray-700 text-sm font-bold mb-2">Stock Quantity:</label>
                        <input type="number" id="stockQuantity" name="stockQuantity" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0" required>
                    </div>
                    <div class="mb-4">
                        <label for="price" class="block text-gray-700 text-sm font-bold mb-2">Price (R):</label>
                        <input type="number" id="price" name="price" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" step="0.01" min="0" required>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button type="submit" class="btn-primary">Add Medication</button>
                        <button type="button" class="btn-secondary" onclick="showSection('list-medications')">Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- View Pending Prescriptions Section -->
        <section id="view-pending-prescriptions" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Pending Prescriptions</h2>
            <p class="text-lg text-gray-700 mb-4">Review and process prescriptions awaiting fulfillment.</p>
            <hr class="mb-6">
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div id="pending-prescriptions-list">
                    <p class="text-center text-gray-600 p-4">No pending prescriptions.</p>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button class="btn-secondary" onclick="showSection('pharmacist-dashboard')">Back to Dashboard</button>
            </div>
        </section>

        <!-- Receptionist Dashboard -->
        <section id="receptionist-dashboard" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Receptionist Dashboard</h2>
            <p class="text-lg text-gray-700 mb-4">Welcome, Receptionist! Here you can manage appointments and patient inquiries.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">Manage Appointments</h3>
                    <p class="text-blue-700 mb-4">View, create, assign staff, and cancel appointments.</p>
                    <button class="btn-primary" onclick="showSection('manage-appointments-receptionist')">Manage Appointments</button>
                </div>
                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-green-800 mb-2">Create New Appointment</h3>
                    <p class="text-green-700 mb-4">Schedule a new appointment for a student.</p>
                    <button class="btn-success" onclick="showSection('create-appointment-receptionist')">Create Appointment</button>
                </div>
                <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-2">View Feedback Report</h3>
                    <p class="text-yellow-700 mb-4">Review patient feedback submissions.</p>
                    <button class="btn-warning" onclick="showSection('feedback-report')">View Report</button>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-purple-800 mb-2">Chat with Staff</h3>
                    <p class="text-purple-700 mb-4">Communicate directly with clinic staff.</p>
                    <button class="btn-indigo" onclick="showSection('chat')">Start Chat</button>
                </div>
            </div>
        </section>

        <!-- Manage Appointments (Receptionist) Section -->
        <section id="manage-appointments-receptionist" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Manage Appointments</h2>
            <p class="text-lg text-gray-700 mb-4">View all appointments and manage their status.</p>
            <hr class="mb-6">
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div id="receptionist-appointments-list">
                    <p class="text-center text-gray-600 p-4">No appointments found.</p>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button class="btn-secondary" onclick="showSection('receptionist-dashboard')">Back to Dashboard</button>
            </div>
        </section>

        <!-- Create Appointment (Receptionist) Section -->
        <section id="create-appointment-receptionist" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Create New Appointment</h2>
            <p class="text-lg text-gray-700 mb-4">Create an appointment for a student.</p>
            <hr class="mb-6">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200">
                <form id="createAppointmentReceptionistForm">
                    <div class="mb-4">
                        <label for="createAppStudentId" class="block text-gray-700 text-sm font-bold mb-2">Student:</label>
                        <select id="createAppStudentId" name="studentId" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="">-- Select Student --</option>
                            <!-- Students will be populated here -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="createAppDateTime" class="block text-gray-700 text-sm font-bold mb-2">Appointment Date & Time:</label>
                        <input type="datetime-local" id="createAppDateTime" name="appointmentDateTime" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-4">
                        <label for="createAppReason" class="block text-gray-700 text-sm font-bold mb-2">Reason for Visit:</label>
                        <textarea id="createAppReason" name="reasonForVisit" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" rows="3" required></textarea>
                    </div>
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="createAppIsVirtual" name="isVirtual" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                        <label for="createAppIsVirtual" class="ml-2 text-gray-700">Virtual Appointment</label>
                    </div>
                    <div id="createAppVirtualFields" class="mb-4 hidden">
                        <label for="createAppPlatform" class="block text-gray-700 text-sm font-bold mb-2">Platform:</label>
                        <select id="createAppPlatform" name="platform" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="">-- Select Platform --</option>
                            <option value="Teams">Microsoft Teams</option>
                            <option value="Zoom">Zoom</option>
                            <option value="GoogleMeet">Google Meet</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button type="submit" class="btn-primary">Create Appointment</button>
                        <button type="button" class="btn-secondary" onclick="showSection('receptionist-dashboard')">Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Feedback Report Section -->
        <section id="feedback-report" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Feedback Report</h2>
            <p class="text-lg text-gray-700 mb-4">View and filter patient feedback.</p>
            <hr class="mb-6">

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Filter Feedback</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label for="filterStaff" class="block text-gray-700 text-sm font-bold mb-1">Filter by Staff:</label>
                        <select id="filterStaff" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                            <option value="">All Staff</option>
                            <!-- Staff will be populated here -->
                        </select>
                    </div>
                    <div>
                        <label for="filterStartDate" class="block text-gray-700 text-sm font-bold mb-1">Start Date:</label>
                        <input type="date" id="filterStartDate" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div>
                        <label for="filterEndDate" class="block text-gray-700 text-sm font-bold mb-1">End Date:</label>
                        <input type="date" id="filterEndDate" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div>
                        <label for="filterMinRating" class="block text-gray-700 text-sm font-bold mb-1">Minimum Rating:</label>
                        <select id="filterMinRating" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                            <option value="">Any</option>
                            <option value="1">1 Star & Up</option>
                            <option value="2">2 Stars & Up</option>
                            <option value="3">3 Stars & Up</option>
                            <option value="4">4 Stars & Up</option>
                            <option value="5">5 Stars</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 lg:col-span-1">
                        <label for="filterKeywords" class="block text-gray-700 text-sm font-bold mb-1">Keywords in Comments:</label>
                        <input type="text" id="filterKeywords" placeholder="e.g., friendly, wait time" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                </div>
                <div class="flex justify-start space-x-4 mt-6">
                    <button class="btn-primary" onclick="renderFeedbackReport()">Apply Filters</button>
                    <button class="btn-secondary" onclick="clearFeedbackFilters()">Clear Filters</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div id="feedback-list">
                    <p class="text-center text-gray-600 p-4">No feedback submitted yet.</p>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button class="btn-outline-blue" onclick="downloadFeedbackListPdf()">Download Feedback List as PDF</button>
                    <button class="btn-primary" onclick="showSection('survey-summary')">View Survey Summary</button>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button class="btn-secondary" onclick="showSection('receptionist-dashboard')">Back to Dashboard</button>
            </div>
        </section>

        <!-- Survey Summary Section -->
        <section id="survey-summary" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Survey Summary</h2>
            <p class="text-lg text-gray-700 mb-4">Analyze overall feedback trends and performance indicators.</p>
            <hr class="mb-6">

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Summary Filters</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="summaryFilterStaff" class="block text-gray-700 text-sm font-bold mb-1">Filter by Staff:</label>
                        <select id="summaryFilterStaff" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                            <option value="">All Staff</option>
                            <!-- Staff will be populated here -->
                        </select>
                    </div>
                    <div>
                        <label for="summaryFilterStartDate" class="block text-gray-700 text-sm font-bold mb-1">Start Date:</label>
                        <input type="date" id="summaryFilterStartDate" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div>
                        <label for="summaryFilterEndDate" class="block text-gray-700 text-sm font-bold mb-1">End Date:</label>
                        <input type="date" id="summaryFilterEndDate" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                </div>
                <div class="flex justify-start space-x-4 mt-6">
                    <button class="btn-primary" onclick="renderSurveySummary()">Apply Filters</button>
                    <button class="btn-secondary" onclick="clearSummaryFilters()">Clear Filters</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div id="summary-content">
                    <p class="text-center text-gray-600 p-4">Apply filters to view summary data.</p>
                </div>
                <div class="flex justify-end items-center mt-6">
                    <button class="btn-outline-blue" onclick="downloadSummaryPdf()">Download Summary as PDF</button>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button class="btn-secondary" onclick="showSection('feedback-report')">Back to Feedback Report</button>
            </div>
        </section>

        <!-- Simulated Nurse Dashboard -->
        <section id="nurse-dashboard" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Nurse Dashboard</h2>
            <p class="text-lg text-gray-700 mb-4">Welcome, Nurse! Here you can manage assigned appointments and assist doctors.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-green-800 mb-2">My Assigned Appointments</h3>
                    <p class="text-green-700 mb-4">View appointments assigned to you and start patient intake.</p>
                    <button class="btn-success" onclick="showSection('my-assigned-appointments-nurse')">View Appointments</button>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-purple-800 mb-2">Chat with Staff</h3>
                    <p class="text-purple-700 mb-4">Communicate directly with clinic staff.</p>
                    <button class="btn-indigo" onclick="showSection('chat')">Start Chat</button>
                </div>
            </div>
        </section>

        <!-- My Assigned Appointments (Nurse) Section -->
        <section id="my-assigned-appointments-nurse" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">My Assigned Appointments</h2>
            <p class="text-lg text-gray-700 mb-4">Here are the appointments assigned to you for initial patient intake.</p>
            <hr class="mb-6">
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div id="nurse-appointments-list">
                    <p class="text-center text-gray-600 p-4">No appointments assigned to you.</p>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button class="btn-secondary" onclick="showSection('nurse-dashboard')">Back to Dashboard</button>
            </div>
        </section>

        <!-- Start Consultation Section (Nurse) -->
        <section id="start-consultation-nurse" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Patient Intake & Vitals</h2>
            <p class="text-lg text-gray-700 mb-4">Record patient vitals and initial observations.</p>
            <hr class="mb-6">
            <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-md border border-gray-200">
                <form id="nurseConsultationForm">
                    <input type="hidden" id="nurseConsultationAppointmentId" name="appointmentId">
                    <input type="hidden" id="nurseConsultationPatientId" name="patientId">
                    <p class="mb-4 text-lg font-semibold">Patient: <span id="nurseConsultationPatientName" class="text-blue-700"></span></p>

                    <h3 class="text-xl font-bold text-gray-800 mb-4 mt-6">Vitals</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="temperature" class="block text-gray-700 text-sm font-bold mb-2">Temperature ($^\circ$C):</label>
                            <input type="number" step="0.1" id="temperature" name="temperature" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., 36.5">
                        </div>
                        <div>
                            <label for="bloodPressure" class="block text-gray-700 text-sm font-bold mb-2">Blood Pressure (mmHg):</label>
                            <input type="text" id="bloodPressure" name="bloodPressure" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., 120/80">
                        </div>
                        <div>
                            <label for="heartRate" class="block text-gray-700 text-sm font-bold mb-2">Heart Rate (bpm):</label>
                            <input type="number" id="heartRate" name="heartRate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., 72">
                        </div>
                        <div>
                            <label for="oxygenSaturation" class="block text-gray-700 text-sm font-bold mb-2">Oxygen Saturation (%):</label>
                            <input type="number" id="oxygenSaturation" name="oxygenSaturation" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0" max="100" placeholder="e.g., 98">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="nurseObservations" class="block text-gray-700 text-sm font-bold mb-2">Nurse Observations:</label>
                        <textarea id="nurseObservations" name="nurseObservations" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32" rows="4"></textarea>
                    </div>

                    <div class="flex items-center justify-between mt-8">
                        <button type="submit" class="btn-primary">Complete Intake</button>
                        <button type="button" class="btn-secondary" onclick="showSection('my-assigned-appointments-nurse')">Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- NEW/MODIFIED SECTION -->
        <!-- Delivery Driver Dashboard -->
        <section id="delivery-driver-dashboard" class="content-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Delivery Dashboard</h2>
            <p class="text-lg text-gray-700 mb-4">Welcome, Driver! Here are the deliveries assigned to you that are ready for confirmation.</p>
            <hr class="mb-6">
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div id="driver-deliveries-list">
                    <p class="text-center text-gray-600 p-4">No deliveries awaiting confirmation.</p>
                </div>
            </div>
        </section>
        <!-- END NEW/MODIFIED SECTION -->


    </main>

    <footer class="bg-gray-800 text-white py-6 mt-auto rounded-t-lg shadow-inner">
        <div class="container mx-auto text-center px-4">
            <p>&copy; 2025 DUT Clinic Management System. All rights reserved.</p>
            <p class="text-sm mt-2">This is a prototype and does not represent a live system.</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Utility function to show custom modal
        function showModal(message) {
            document.getElementById('modalMessage').innerText = message;
            document.getElementById('customModal').style.display = 'flex';
        }

        // Utility function to close custom modal
        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        // --- Global State ---
        let currentUserRole = 'Guest';
        let currentUserId = 'guest-user'; // Simulated user ID for guest
        let currentChatReceiverId = null;
        let paymentMade = false; // Flag for delivery payment

        // Low stock threshold constant
        const LOW_STOCK_THRESHOLD = 20;


        // Simulated User Data (for chat contacts)
        const simulatedUsers = [
            {
                id: 'student-1', name: 'Alice Student', role: 'Student', chronicCondition: true, dutResidence: 'Residence A',
                emergencyContacts: [
                    { name: 'John Doe', relationship: 'Father', phone: '0821112222', email: 'john.doe@example.com' },
                    { name: 'Jane Smith', relationship: 'Mother', phone: '0713334444', email: 'jane.smith@example.com' }
                ]
            },
            { id: 'student-2', name: 'Bob Student', role: 'Student', chronicCondition: false, dutResidence: null, emergencyContacts: [] },
            {
                id: 'student-3', name: 'Charlie Student', role: 'Student', chronicCondition: true, dutResidence: 'Residence C',
                emergencyContacts: [
                    { name: 'David Brown', relationship: 'Brother', phone: '0635556666', email: 'david.brown@example.com' }
                ]
            },
            { id: 'doctor-1', name: 'Dr. Emily Doctor', role: 'Doctor' },
            { id: 'doctor-2', name: 'Dr. David Doctor', role: 'Doctor' },
            { id: 'pharmacist-1', name: 'Charlie Pharmacist', role: 'Pharmacist' },
            { id: 'receptionist-1', name: 'Diana Receptionist', role: 'Receptionist' },
            { id: 'nurse-1', name: 'Eve Nurse', role: 'Nurse' },
            { id: 'nurse-2', name: 'Frank Nurse', role: 'Nurse' },
            { id: 'admin-1', name: 'Frank Admin', role: 'Admin' },
            // <!-- NEW/MODIFIED SECTION -->
            { id: 'driver-1', name: 'Grace Driver', role: 'DeliveryDriver' }
            // <!-- END NEW/MODIFIED SECTION -->
        ];

        const dutResidences = [
            { id: 'res-A', name: 'Residence A', address: '101 University Rd, Durban' },
            { id: 'res-B', name: 'Residence B', address: '202 College Ave, Durban' },
            { id: 'res-C', name: 'Residence C', address: '303 Campus Blvd, Durban' }
        ];

        // --- Data Storage (localStorage simulation) ---
        function getAppointments() {
            return JSON.parse(localStorage.getItem('appointments')) || [];
        }

        function saveAppointments(appointments) {
            localStorage.setItem('appointments', JSON.stringify(appointments));
        }

        function getChatMessages() {
            return JSON.parse(localStorage.getItem('chatMessages')) || [];
        }

        function saveChatMessages(messages) {
            localStorage.setItem('chatMessages', JSON.stringify(messages));
        }

        function getMedications() {
            return JSON.parse(localStorage.getItem('medications')) || [];
        }

        function saveMedications(medications) {
            localStorage.setItem('medications', JSON.stringify(medications));
        }

        function getPrescriptions() {
            return JSON.parse(localStorage.getItem('prescriptions')) || [];
        }

        function savePrescriptions(prescriptions) {
            localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
        }

        function getMedicalHistoryEntries() {
            return JSON.parse(localStorage.getItem('medicalHistoryEntries')) || [];
        }

        function saveMedicalHistoryEntries(entries) {
            localStorage.setItem('medicalHistoryEntries', JSON.stringify(entries));
        }

        function getMedicalCertificates() {
            return JSON.parse(localStorage.getItem('medicalCertificates')) || [];
        }

        function saveMedicalCertificates(certificates) {
            localStorage.setItem('medicalCertificates', JSON.stringify(certificates));
        }

        function getFeedback() {
            return JSON.parse(localStorage.getItem('feedback')) || [];
        }

        function saveFeedback(feedback) {
            localStorage.setItem('feedback', JSON.stringify(feedback));
        }

        function getDeliveryRequests() {
            return JSON.parse(localStorage.getItem('deliveryRequests')) || [];
        }

        function saveDeliveryRequests(requests) {
            localStorage.setItem('deliveryRequests', JSON.stringify(requests));
        }

        function getAmbulanceRequests() {
            return JSON.parse(localStorage.getItem('ambulanceRequests')) || [];
        }

        function saveAmbulanceRequests(requests) {
            localStorage.setItem('ambulanceRequests', JSON.stringify(requests));
        }

        function getEmergencyNotifications() {
            return JSON.parse(localStorage.getItem('emergencyNotifications')) || [];
        }

        function saveEmergencyNotifications(notifications) {
            localStorage.setItem('emergencyNotifications', JSON.stringify(notifications));
        }

        function getDutResidences() {
            return JSON.parse(localStorage.getItem('dutResidences')) || [];
        }

        function saveDutResidences(residences) {
            localStorage.setItem('dutResidences', JSON.stringify(residences));
        }


        // --- UI Functions ---
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('text-blue-500', 'font-bold');
                link.classList.add('text-gray-700');
            });
            const activeLink = document.querySelector(`.nav-link[data-target="${sectionId}"]`);
            if (activeLink) {
                activeLink.classList.add('text-blue-500', 'font-bold');
                activeLink.classList.remove('text-gray-700');
            }

            // Special handling for dashboards and specific lists
            if (sectionId === 'student-dashboard' && currentUserRole !== 'Student') {
                showSection('home'); // Redirect if not student
            } else if (sectionId === 'pharmacist-dashboard' && currentUserRole !== 'Pharmacist') {
                showSection('home'); // Redirect if not pharmacist
            } else if (sectionId === 'list-medications' && currentUserRole === 'Pharmacist') {
                renderMedications();
            } else if (sectionId === 'view-pending-prescriptions' && currentUserRole === 'Pharmacist') {
                renderPendingPrescriptions();
            } else if (sectionId === 'doctor-dashboard' && currentUserRole !== 'Doctor') {
                showSection('home'); // Redirect if not doctor
            } else if (sectionId === 'my-assigned-appointments-doctor' && currentUserRole === 'Doctor') {
                renderDoctorAssignedAppointments();
            } else if (sectionId === 'nurse-dashboard' && currentUserRole !== 'Nurse') {
                showSection('home'); // Redirect if not nurse
            } else if (sectionId === 'my-assigned-appointments-nurse' && currentUserRole === 'Nurse') {
                renderNurseAssignedAppointments();
            } else if (sectionId === 'receptionist-dashboard' && currentUserRole !== 'Receptionist') {
                showSection('home'); // Redirect if not receptionist
            } else if (sectionId === 'manage-appointments-receptionist' && currentUserRole === 'Receptionist') {
                renderReceptionistAppointments();
            } else if (sectionId === 'create-appointment-receptionist' && currentUserRole === 'Receptionist') {
                populateStudentDropdown();
            } else if (sectionId === 'feedback-report' && currentUserRole === 'Receptionist') {
                populateStaffDropdown('filterStaff', ['Doctor', 'Nurse']); // Populate staff filter
                renderFeedbackReport();
            } else if (sectionId === 'survey-summary' && currentUserRole === 'Receptionist') {
                populateStaffDropdown('summaryFilterStaff', ['Doctor', 'Nurse']); // Populate staff filter for summary
                renderSurveySummary();
            }
            else if (sectionId === 'my-delivery-requests' && currentUserRole === 'Student') {
                renderMyDeliveryRequests();
            } else if (sectionId === 'request-prescription-delivery' && currentUserRole === 'Student') {
                populatePrescriptionToDeliverDropdown();
                setupDeliveryTypeListeners(); // Setup listeners for delivery type radios
                populateDutResidenceDropdown(); // Populate DUT residences
                toggleDeliveryAddressFields(); // Set initial state of address fields
            } else if (sectionId === 'schedule-follow-up' && currentUserRole === 'Doctor') {
                populateChronicPatientsDropdown();
            } else if (sectionId === 'submit-feedback' && currentUserRole === 'Student') {
                populateFeedbackAppointmentsDropdown();
            } else if (sectionId === 'request-emergency-services' && currentUserRole === 'Student') {
                prepareEmergencyRequest();
            }
            // <!-- NEW/MODIFIED SECTION -->
            else if (sectionId === 'delivery-driver-dashboard' && currentUserRole === 'DeliveryDriver') {
                renderDriverDeliveries();
            }
            // <!-- END NEW/MODIFIED SECTION -->
        }

        function updateNavigationVisibility(role) {
            document.querySelectorAll('.nav-link').forEach(link => {
                const rolesAttr = link.getAttribute('data-roles');
                if (rolesAttr) {
                    const allowedRoles = rolesAttr.split(',');
                    if (allowedRoles.includes(role)) {
                        link.classList.remove('hidden');
                    } else {
                        link.classList.add('hidden');
                    }
                }
            });

            // Show appropriate dashboard based on role or home
            if (role === 'Student') {
                showSection('student-dashboard');
            } else if (role === 'Doctor') {
                showSection('doctor-dashboard');
            } else if (role === 'Pharmacist') {
                showSection('pharmacist-dashboard');
            } else if (role === 'Receptionist') {
                showSection('receptionist-dashboard');
            } else if (role === 'Nurse') {
                showSection('nurse-dashboard');
            } else if (role === 'Admin') {
                showSection('admin-dashboard');
            }
            // <!-- NEW/MODIFIED SECTION -->
            else if (role === 'DeliveryDriver') {
                showSection('delivery-driver-dashboard');
            }
            // <!-- END NEW/MODIFIED SECTION -->
            else { // Guest
                showSection('home');
            }
        }

        // --- Appointment Logic (Student) ---
        document.getElementById('bookAppointmentForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const dateTime = document.getElementById('appointmentDateTime').value;
            const reason = document.getElementById('reasonForVisit').value;
            const isVirtual = document.getElementById('isVirtualCheckbox').checked;
            const platform = isVirtual ? document.getElementById('platform').value : '';

            if (!dateTime || !reason) {
                showModal('Please fill in all required fields.');
                return;
            }

            const newAppointment = {
                id: 'app-' + Date.now().toString().slice(-6), // Simple unique ID
                studentId: currentUserId, // Assign to current simulated user
                appointmentDateTime: dateTime,
                reasonForVisit: reason,
                isVirtual: isVirtual,
                platform: platform,
                status: 'PendingAssignment', // Default status for new requests
                assignedStaff: 'Not yet assigned',
                assignedDoctorId: null,
                assignedNurseId: null,
                hasFeedback: false,
                isFollowUp: false, // Not a follow-up by default
                reminders: [] // No reminders yet
            };

            const appointments = getAppointments();
            appointments.push(newAppointment);
            saveAppointments(appointments);

            showModal('Appointment request submitted successfully! A receptionist will assign staff shortly.');
            this.reset(); // Clear the form
            document.getElementById('virtualAppointmentFields').classList.add('hidden'); // Hide virtual fields

            renderAppointments('upcoming'); // Refresh appointments list
            showSection('my-appointments'); // Navigate to my appointments
        });

        document.getElementById('isVirtualCheckbox').addEventListener('change', function () {
            const virtualFields = document.getElementById('virtualAppointmentFields');
            if (this.checked) {
                virtualFields.classList.remove('hidden');
            } else {
                virtualFields.classList.add('hidden');
            }
        });

        function renderAppointments(filter) {
            const appointments = getAppointments().filter(app => app.studentId === currentUserId);
            const appointmentsList = document.getElementById('appointments-list');
            appointmentsList.innerHTML = ''; // Clear previous list

            const now = new Date();
            const filteredAppointments = appointments.filter(app => {
                const appDate = new Date(app.appointmentDateTime);
                if (filter === 'upcoming') {
                    return appDate >= now;
                } else if (filter === 'past') {
                    return appDate < now;
                }
                return true; // Should not happen with current filter options
            }).sort((a, b) => new Date(a.appointmentDateTime) - new Date(b.appointmentDateTime)); // Sort by date

            if (filteredAppointments.length === 0) {
                appointmentsList.innerHTML = `<p class="text-center text-gray-600 p-4">You have no ${filter} appointments.</p>`;
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned Staff</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="appointments-table-body">
                    </tbody>
                `;
            appointmentsList.appendChild(table);
            const tbody = document.getElementById('appointments-table-body');

            filteredAppointments.forEach(app => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';

                const statusClasses = {
                    'Completed': 'bg-green-100 text-green-800',
                    'Scheduled': 'bg-blue-100 text-blue-800',
                    'PendingAssignment': 'bg-yellow-100 text-yellow-800',
                    'CancelledByClinic': 'bg-red-100 text-red-800',
                    'CancelledByStudent': 'bg-red-100 text-red-800'
                };
                const statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClasses[app.status] || 'bg-gray-100 text-gray-800'}">${app.status}</span>`;
                const typeBadge = app.isVirtual ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">Virtual</span>' : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">In-Person</span>';

                let assignedStaffName = 'Not yet assigned';
                if (app.assignedDoctorId) {
                    const doctor = simulatedUsers.find(u => u.id === app.assignedDoctorId);
                    assignedStaffName = doctor ? `Dr. ${doctor.name.split(' ')[1]}` : 'Assigned Doctor';
                } else if (app.assignedNurseId) {
                    const nurse = simulatedUsers.find(u => u.id === app.assignedNurseId);
                    assignedStaffName = nurse ? `Nurse ${nurse.name.split(' ')[1]}` : 'Assigned Nurse';
                }


                let actionsHtml = '';
                if (app.isVirtual && app.status === 'Scheduled' && app.assignedDoctorId === currentUserId) { // Only doctor can join their own virtual call
                    actionsHtml = `<button class="btn-success-sm" onclick="showModal('Joining virtual consultation for appointment ID: ${app.id} on ${app.platform}.')"><i class="fas fa-video mr-1"></i> Join Call</button>`;
                } else if (app.status === 'Completed' && !app.hasFeedback) {
                    // Direct to the new feedback section with pre-selected appointment
                    actionsHtml = `<button class="btn-outline-blue-sm" onclick="showSection('submit-feedback'); populateFeedbackAppointmentsDropdown('${app.id}');"><i class="fas fa-star mr-1"></i> Leave Feedback</button>`;
                } else if (app.status === 'Completed' && app.hasFeedback) {
                    actionsHtml = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i> Feedback Submitted</span>`;
                } else if (app.isFollowUp && app.status === 'Scheduled' && app.reminders && app.reminders.some(r => r.status === 'Sent' && !r.responseType)) {
                    // If it's a follow-up, scheduled, and has an unresponded reminder
                    actionsHtml = `
                            <button class="btn-outline-indigo-sm mr-2" onclick="acknowledgeReminder('${app.id}')">Acknowledge</button>
                            <button class="btn-outline-red-sm" onclick="showModal('Reschedule feature not implemented in prototype.')">Reschedule</button>
                        `;
                }
                else {
                    actionsHtml = `<span class="text-gray-500">No actions</span>`;
                }

                row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(app.appointmentDateTime).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${app.reasonForVisit} ${app.isFollowUp ? '<span class="badge bg-green-200 text-green-800 ml-2">Follow-Up</span>' : ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${assignedStaffName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${typeBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${actionsHtml}</td>
                    `;
            });

            // Update tab button styles
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.querySelector(`.tab-button[data-filter="${filter}"]`).classList.add('bg-blue-500', 'text-white');
            document.querySelector(`.tab-button[data-filter="${filter}"]`).classList.remove('bg-gray-200', 'text-gray-700');
        }

        // --- Student Feedback Logic ---
        function populateFeedbackAppointmentsDropdown(preSelectedAppointmentId = null) {
            const feedbackSelect = document.getElementById('feedbackAppointmentId');
            feedbackSelect.innerHTML = '<option value="">-- Select Appointment --</option>'; // Clear existing options
            const noFeedbackAppointmentsMessage = document.getElementById('noFeedbackAppointmentsMessage');
            noFeedbackAppointmentsMessage.classList.add('hidden');

            const completedAppointments = getAppointments().filter(app =>
                app.studentId === currentUserId &&
                app.status === 'Completed' &&
                !app.hasFeedback
            );

            if (completedAppointments.length === 0) {
                noFeedbackAppointmentsMessage.classList.remove('hidden');
                feedbackSelect.disabled = true;
                document.querySelector('#feedbackForm button[type="submit"]').disabled = true;
                return;
            } else {
                feedbackSelect.disabled = false;
                document.querySelector('#feedbackForm button[type="submit"]').disabled = false;
            }

            completedAppointments.forEach(app => {
                const option = document.createElement('option');
                option.value = app.id;
                option.innerText = `Appointment ${app.id} on ${new Date(app.appointmentDateTime).toLocaleDateString()} for ${app.reasonForVisit}`;
                feedbackSelect.appendChild(option);
            });

            if (preSelectedAppointmentId) {
                feedbackSelect.value = preSelectedAppointmentId;
            }
        }

        document.getElementById('feedbackForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const appointmentId = document.getElementById('feedbackAppointmentId').value;
            const rating = document.getElementById('feedbackRating').value;
            const comments = document.getElementById('feedbackComments').value;

            if (!appointmentId || !rating) {
                showModal('Please select an appointment and provide a rating.');
                return;
            }

            // Get the associated appointment to retrieve staff info
            const appointments = getAppointments();
            const appointment = appointments.find(app => app.id === appointmentId);
            let assignedDoctorId = null;
            let assignedNurseId = null;
            let assignedStaffNames = [];

            if (appointment) {
                assignedDoctorId = appointment.assignedDoctorId;
                assignedNurseId = appointment.assignedNurseId;
                if (assignedDoctorId) {
                    const doctor = simulatedUsers.find(u => u.id === assignedDoctorId);
                    if (doctor) assignedStaffNames.push(doctor.name);
                }
                if (assignedNurseId) {
                    const nurse = simulatedUsers.find(u => u.id === assignedNurseId);
                    if (nurse) assignedStaffNames.push(nurse.name);
                }
            }


            // Save feedback
            let feedbackEntries = getFeedback();
            const student = simulatedUsers.find(u => u.id === currentUserId);
            feedbackEntries.push({
                id: 'fdbk-' + Date.now().toString().slice(-6),
                appointmentId: appointmentId,
                studentId: currentUserId,
                studentName: student ? student.name : 'Unknown Student',
                rating: parseInt(rating), // Store as integer for easier filtering/calculations
                comments: comments || 'No comments provided.',
                timestamp: new Date().toISOString(),
                assignedDoctorId: assignedDoctorId, // Store assigned staff IDs for filtering
                assignedNurseId: assignedNurseId,
                assignedStaffNames: assignedStaffNames // Store names for display/filtering
            });
            saveFeedback(feedbackEntries);

            // Update appointment to mark as feedback submitted
            const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);
            if (appointmentIndex > -1) {
                appointments[appointmentIndex].hasFeedback = true;
                saveAppointments(appointments);
            }

            showModal('Thank you for your feedback! It has been submitted anonymously.');
            this.reset();
            showSection('student-dashboard'); // Go back to student dashboard
        });

        // --- Request Emergency Services Logic (Student) ---
        function prepareEmergencyRequest() {
            const student = simulatedUsers.find(u => u.id === currentUserId);
            document.getElementById('emergencyStudentId').value = currentUserId;
            document.getElementById('emergencyStudentName').innerText = student ? student.name : 'Unknown Student';
            // You could pre-fill location here if student data included it
            document.getElementById('emergencyLocation').value = '';
            document.getElementById('emergencyDescription').value = '';
        }

        document.getElementById('emergencyRequestForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const studentId = document.getElementById('emergencyStudentId').value;
            const location = document.getElementById('emergencyLocation').value;
            const description = document.getElementById('emergencyDescription').value;

            if (!location || !description) {
                showModal('Please provide your location and a brief description of the emergency.');
                return;
            }

            const newAmbulanceRequest = {
                id: 'amb-' + Date.now().toString().slice(-6),
                studentId: studentId,
                studentName: simulatedUsers.find(u => u.id === studentId)?.name || 'Unknown Student',
                location: location,
                emergencyDescription: description,
                requestTime: new Date().toISOString(),
                status: 'Pending Dispatch'
            };

            const ambulanceRequests = getAmbulanceRequests();
            ambulanceRequests.push(newAmbulanceRequest);
            saveAmbulanceRequests(ambulanceRequests);

            showModal('Emergency request submitted. Ambulance dispatched! Your emergency contacts will be notified.');
            notifyEmergencyContacts(studentId, newAmbulanceRequest.id); // Trigger notification

            this.reset();
            showSection('student-dashboard');
        });

        // --- Notify Emergency Contacts Logic (System) ---
        function notifyEmergencyContacts(patientId, requestId) {
            const patient = simulatedUsers.find(u => u.id === patientId);
            if (!patient || !patient.emergencyContacts || patient.emergencyContacts.length === 0) {
                console.warn(`Patient ${patientId} has no emergency contacts to notify.`);
                return;
            }

            let emergencyNotifications = getEmergencyNotifications();

            patient.emergencyContacts.forEach(contact => {
                const message = `URGENT: An ambulance has been dispatched for ${patient.name} due to an emergency. Location: ${getAmbulanceRequests().find(req => req.id === requestId)?.location || 'Unknown'}. Please contact them for more details.`;

                const newNotification = {
                    id: 'notif-' + Date.now().toString().slice(-6),
                    requestId: requestId,
                    patientId: patientId,
                    contactName: contact.name,
                    contactMethod: contact.phone ? `SMS to ${contact.phone}` : `Email to ${contact.email}`,
                    message: message,
                    timestamp: new Date().toISOString(),
                    status: 'Sent'
                };
                emergencyNotifications.push(newNotification);
                console.log(`[SIMULATED NOTIFICATION] Sent to ${contact.name} (${contact.relationship}): ${message}`);
            });
            saveEmergencyNotifications(emergencyNotifications);
        }

        // --- Chat Logic ---
        function renderContacts() {
            const contactListDiv = document.getElementById('contactList');
            contactListDiv.innerHTML = ''; // Clear existing contacts

            // Filter out the current user from the contact list
            const contacts = simulatedUsers.filter(user => user.id !== currentUserId);

            contacts.forEach(user => {
                const contactDiv = document.createElement('div');
                contactDiv.className = 'contact p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-100 rounded-md';
                contactDiv.setAttribute('data-userid', user.id);
                contactDiv.innerHTML = `
                        <div class="font-semibold text-gray-800">${user.name}</div>
                        <small class="text-gray-500">${user.role}</small>
                    `;
                contactDiv.addEventListener('click', () => selectChatUser(user.id, user.name));
                contactListDiv.appendChild(contactDiv);
            });
        }

        function selectChatUser(userId, userName) {
            currentChatReceiverId = userId;
            document.getElementById('chatHeader').innerText = `Chat with ${userName}`;
            document.getElementById('messagesArea').innerHTML = ''; // Clear messages

            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('messageInput').focus();

            // Highlight active contact
            document.querySelectorAll('.contact').forEach(c => c.classList.remove('active', 'bg-blue-200'));
            document.querySelector(`.contact[data-userid='${userId}']`).classList.add('active', 'bg-blue-200');

            renderChatMessages();
        }

        function renderChatMessages() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';
            const allMessages = getChatMessages();

            const relevantMessages = allMessages.filter(msg =>
                (msg.senderId === currentUserId && msg.receiverId === currentChatReceiverId) ||
                (msg.senderId === currentChatReceiverId && msg.receiverId === currentUserId)
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (relevantMessages.length === 0) {
                messagesArea.innerHTML = '<p class="text-center text-gray-500 p-4">No messages yet. Start the conversation!</p>';
            }

            relevantMessages.forEach(msg => {
                appendChatMessage(msg.senderId, msg.senderName, msg.messageContent, msg.timestamp);
            });
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function appendChatMessage(senderId, senderName, messageContent, timestamp) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');

            const messageType = (senderId === currentUserId) ? 'sent' : 'received';
            messageDiv.className = `message ${messageType} flex ${messageType === 'sent' ? 'justify-end' : 'justify-start'}`;

            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = `message-content rounded-xl p-3 max-w-xs ${messageType === 'sent' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}`;

            const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageContentDiv.innerHTML = `
                    <div class="text-xs font-bold ${messageType === 'sent' ? 'text-blue-100' : 'text-gray-600'} mb-1">${senderId === currentUserId ? 'You' : senderName} <span class="font-normal opacity-75 ml-1">${time}</span></div>
                    <div>${messageContent}</div>
                `;
            messageDiv.appendChild(messageContentDiv);
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        document.getElementById('sendButton').addEventListener('click', sendChatMessage);
        document.getElementById('messageInput').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChatMessage();
            }
        });

        function sendChatMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (message && currentChatReceiverId) {
                const senderUser = simulatedUsers.find(u => u.id === currentUserId);
                const senderName = senderUser ? senderUser.name : 'Unknown';
                const timestamp = new Date().toISOString();

                const newMessage = {
                    senderId: currentUserId,
                    senderName: senderName,
                    receiverId: currentChatReceiverId,
                    messageContent: message,
                    timestamp: timestamp
                };

                const chatMessages = getChatMessages();
                chatMessages.push(newMessage);
                saveChatMessages(chatMessages);

                appendChatMessage(newMessage.senderId, newMessage.senderName, newMessage.messageContent, newMessage.timestamp);
                messageInput.value = ''; // Clear input
            }
        }

        // --- Pharmacist Specific Logic ---

        // Medications
        document.getElementById('createMedicationForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const name = document.getElementById('medicationName').value;
            const dosage = document.getElementById('dosage').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            const price = parseFloat(document.getElementById('price').value);

            if (!name || !dosage || isNaN(quantity) || isNaN(price)) {
                showModal('Please fill in all medication fields correctly.');
                return;
            }

            const newMedication = {
                id: Date.now().toString(),
                name: name,
                dosage: dosage,
                stockQuantity: quantity,
                price: price
            };

            const medications = getMedications();
            medications.push(newMedication);
            saveMedications(medications);

            showModal(`Medication "${name}" added successfully!`);
            this.reset();
            renderMedications(); // Refresh the list
            showSection('list-medications'); // Navigate back to list
        });

        // Modified renderMedications to show low stock alerts
        function renderMedications() {
            const medications = getMedications();
            const medicationsListDiv = document.getElementById('medications-list');
            medicationsListDiv.innerHTML = '';

            if (medications.length === 0) {
                medicationsListDiv.innerHTML = '<p class="text-center text-gray-600 p-4">No medications in stock.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dosage</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price (R)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="medications-table-body">
                    </tbody>
                `;
            medicationsListDiv.appendChild(table);
            const tbody = document.getElementById('medications-table-body');

            medications.forEach(med => {
                const row = tbody.insertRow();
                const isLowStock = med.stockQuantity <= LOW_STOCK_THRESHOLD;
                row.className = `hover:bg-gray-50 ${isLowStock ? 'bg-red-100' : ''}`;

                let stockCellHtml = med.stockQuantity;
                if (isLowStock) {
                    stockCellHtml += ` <span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-200 text-red-800">Low Stock</span>`;
                }


                row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${med.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${med.dosage}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${stockCellHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap">R${med.price.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="btn-outline-blue-sm" onclick="showModal('Editing medication ${med.name} (ID: ${med.id}) is not yet implemented.')">Edit</button>
                        </td>
                    `;
            });
        }

        // Prescriptions
        function renderPendingPrescriptions() {
            const prescriptions = getPrescriptions().filter(p => p.status === 'Pending');
            const pendingPrescriptionsListDiv = document.getElementById('pending-prescriptions-list');
            pendingPrescriptionsListDiv.innerHTML = '';

            if (prescriptions.length === 0) {
                pendingPrescriptionsListDiv.innerHTML = '<p class="text-center text-gray-600 p-4">No pending prescriptions.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prescription ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medications</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Prescribed</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="pending-prescriptions-table-body">
                    </tbody>
                `;
            pendingPrescriptionsListDiv.appendChild(table);
            const tbody = document.getElementById('pending-prescriptions-table-body');

            prescriptions.forEach(p => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';

                const medsList = p.medications.map(m => `${m.name} (${m.dosage}) x${m.quantity}`).join(', ');

                row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${p.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${p.patientId}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${medsList}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(p.datePrescribed).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">${p.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="btn-success-sm" onclick="processPrescription('${p.id}')">Process</button>
                        </td>
                    `;
            });
        }

        function processPrescription(prescriptionId) {
            let prescriptions = getPrescriptions();
            const prescriptionIndex = prescriptions.findIndex(p => p.id === prescriptionId);

            if (prescriptionIndex > -1) {
                prescriptions[prescriptionIndex].status = 'Ready for Collection';
                savePrescriptions(prescriptions);
                showModal(`Prescription ${prescriptionId} processed and is now Ready for Collection.`);
                renderPendingPrescriptions(); // Refresh the list
            } else {
                showModal(`Prescription ${prescriptionId} not found.`);
            }
        }

        // --- Doctor Specific Logic ---

        function renderDoctorAssignedAppointments() {
            const appointments = getAppointments().filter(app => app.assignedDoctorId === currentUserId && app.status === 'Scheduled');
            const doctorAppointmentsListDiv = document.getElementById('doctor-appointments-list');
            doctorAppointmentsListDiv.innerHTML = '';

            if (appointments.length === 0) {
                doctorAppointmentsListDiv.innerHTML = '<p class="text-center text-gray-600 p-4">No scheduled appointments assigned to you.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="doctor-appointments-table-body">
                    </tbody>
                `;
            doctorAppointmentsListDiv.appendChild(table);
            const tbody = document.getElementById('doctor-appointments-table-body');

            appointments.forEach(app => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';

                const patient = simulatedUsers.find(u => u.id === app.studentId);
                const patientName = patient ? patient.name : app.studentId;

                const typeBadge = app.isVirtual ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">Virtual</span>' : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">In-Person</span>';

                row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(app.appointmentDateTime).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${patientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${app.reasonForVisit}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${typeBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="btn-success-sm" onclick="prepareConsultation('${app.id}', '${app.studentId}', '${patientName}')">Start Consultation</button>
                        </td>
                    `;
            });
        }

        function prepareConsultation(appointmentId, patientId, patientName) {
            // Set hidden fields in the consultation form
            document.getElementById('consultationAppointmentId').value = appointmentId;
            document.getElementById('consultationPatientId').value = patientId;
            document.getElementById('consultationPatientName').innerText = patientName;

            // Clear previous inputs
            document.getElementById('medicalHistoryNotes').value = '';
            document.getElementById('diagnosis').value = '';
            document.getElementById('medication-inputs-container').innerHTML = ''; // Clear existing medication inputs
            addMedicationInput(); // Add one empty medication input by default

            // Pre-fill medical history if available
            const medicalHistoryEntries = getMedicalHistoryEntries().filter(entry => entry.patientId === patientId);
            if (medicalHistoryEntries.length > 0) {
                let historyText = "Previous Medical History:\n";
                medicalHistoryEntries.forEach(entry => {
                    historyText += `\nDate: ${new Date(entry.timestamp).toLocaleDateString()}\n`;
                    if (entry.nurseNotes) {
                        historyText += `Nurse Notes: ${entry.nurseNotes}\n`;
                        if (entry.vitals) {
                            historyText += `Vitals: Temp: ${entry.vitals.temperature}°C, BP: ${entry.vitals.bloodPressure}, HR: ${entry.vitals.heartRate}bpm, O2: ${entry.vitals.oxygenSaturation}%\n`;
                        }
                    }
                    if (entry.notes) historyText += `Doctor Notes: ${entry.notes}\n`;
                    if (entry.diagnosis) historyText += `Diagnosis: ${entry.diagnosis}\n`;
                    if (entry.prescribedMedications && entry.prescribedMedications.length > 0) {
                        historyText += `Prescribed: ${entry.prescribedMedications.map(m => `${m.name} x${m.quantity}`).join(', ')}\n`;
                    }
                    historyText += "--------------------\n";
                });
                document.getElementById('medicalHistoryNotes').value = historyText;
            }

            showSection('start-consultation');
        }

        let medicationInputCounter = 0;
        function addMedicationInput() {
            const container = document.getElementById('medication-inputs-container');
            const newIndex = medicationInputCounter++;
            const div = document.createElement('div');
            div.className = 'flex items-end space-x-2 mb-3 medication-item';
            div.innerHTML = `
                    <div class="flex-grow">
                        <label for="medicationSelect_${newIndex}" class="block text-gray-700 text-sm font-bold mb-1">Medication:</label>
                        <select id="medicationSelect_${newIndex}" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline medication-select">
                            <option value="">Select Medication</option>
                        </select>
                    </div>
                    <div>
                        <label for="medicationQuantity_${newIndex}" class="block text-gray-700 text-sm font-bold mb-1">Quantity:</label>
                        <input type="number" id="medicationQuantity_${newIndex}" class="shadow border rounded w-24 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline medication-quantity" min="1" value="1">
                    </div>
                    <button type="button" class="btn-danger-sm" onclick="removeMedicationInput(this)">Remove</button>
                `;
            container.appendChild(div);
            populateMedicationDropdown(document.getElementById(`medicationSelect_${newIndex}`));
        }

        function removeMedicationInput(button) {
            button.closest('.medication-item').remove();
        }

        function populateMedicationDropdown(selectElement) {
            const medications = getMedications();
            medications.forEach(med => {
                const option = document.createElement('option');
                option.value = med.id;
                option.innerText = `${med.name} (${med.dosage})`;
                selectElement.appendChild(option);
            });
        }

        // Modified consultation form submission to check and reduce stock
        document.getElementById('consultationForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const appointmentId = document.getElementById('consultationAppointmentId').value;
            const patientId = document.getElementById('consultationPatientId').value;
            const medicalHistoryNotes = document.getElementById('medicalHistoryNotes').value;
            const diagnosis = document.getElementById('diagnosis').value;

            // Collect prescribed medications
            const prescribedMedications = [];
            let allMedications = getMedications(); // Get current stock levels
            let lowStockAlerts = [];
            let validationFailed = false;

            document.querySelectorAll('.medication-item').forEach(item => {
                if (validationFailed) return;

                const medSelect = item.querySelector('.medication-select');
                const medQuantityInput = item.querySelector('.medication-quantity');
                const medQuantity = parseInt(medQuantityInput.value);

                if (medSelect.value && medQuantity > 0) {
                    const selectedMed = allMedications.find(m => m.id === medSelect.value);
                    if (selectedMed) {
                        // Stock validation
                        if (selectedMed.stockQuantity < medQuantity) {
                            showModal(`Error: Insufficient stock for ${selectedMed.name}. Only ${selectedMed.stockQuantity} units available.`);
                            validationFailed = true;
                            return;
                        }

                        // Add to prescription list
                        prescribedMedications.push({
                            id: selectedMed.id,
                            name: selectedMed.name,
                            dosage: selectedMed.dosage,
                            quantity: medQuantity
                        });

                        // Deduct stock (but don't save yet, do it all at the end)
                        selectedMed.stockQuantity -= medQuantity;

                        // Check for low stock alert
                        if (selectedMed.stockQuantity <= LOW_STOCK_THRESHOLD) {
                            lowStockAlerts.push(`${selectedMed.name} is now low on stock (${selectedMed.stockQuantity} units remaining).`);
                        }
                    }
                }
            });

            if (validationFailed) {
                return; // Stop submission if validation failed
            }

            // If validation passed, save everything
            saveMedications(allMedications); // Save updated stock levels

            // Save Medical History Entry (Doctor's part)
            const newMedicalHistoryEntry = {
                id: Date.now().toString(),
                patientId: patientId,
                doctorId: currentUserId,
                timestamp: new Date().toISOString(),
                notes: medicalHistoryNotes, // Doctor's notes
                diagnosis: diagnosis,
                prescribedMedications: prescribedMedications
            };
            const medicalHistoryEntries = getMedicalHistoryEntries();
            medicalHistoryEntries.push(newMedicalHistoryEntry);
            saveMedicalHistoryEntries(medicalHistoryEntries);

            // Create Prescription if medications were prescribed
            if (prescribedMedications.length > 0) {
                const newPrescription = {
                    id: 'pres-' + Date.now().toString().slice(-6), // Simple short ID
                    patientId: patientId,
                    doctorId: currentUserId,
                    medications: prescribedMedications,
                    datePrescribed: new Date().toISOString(),
                    status: 'Pending', // Pending for pharmacist to process
                    pharmacistNotes: '',
                    isDeliveryRequested: false // New flag for delivery module
                };
                const prescriptions = getPrescriptions();
                prescriptions.push(newPrescription);
                savePrescriptions(prescriptions);
            }

            // Update appointment status to 'Completed'
            let appointments = getAppointments();
            const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);
            if (appointmentIndex > -1) {
                appointments[appointmentIndex].status = 'Completed';
                saveAppointments(appointments);
            }

            // Display appropriate final message
            let finalMessage = "Consultation completed successfully!";
            if (prescribedMedications.length > 0) {
                finalMessage = 'Consultation completed and prescription sent to pharmacist!';
            }
            if (lowStockAlerts.length > 0) {
                finalMessage += "\n\nHeads Up:\n" + lowStockAlerts.join("\n");
            }
            showModal(finalMessage);

            this.reset();
            showSection('my-assigned-appointments-doctor'); // Go back to assigned appointments
        });


        // Medical Certificate Logic
        document.getElementById('medicalCertificateForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const studentId = document.getElementById('certificateStudentId').value;
            const reason = document.getElementById('certificateReason').value;
            const startDate = document.getElementById('certificateStartDate').value;
            const endDate = document.getElementById('certificateEndDate').value;

            if (!studentId || !reason || !startDate || !endDate) {
                showModal('Please fill in all medical certificate fields.');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                showModal('End date cannot be before start date.');
                return;
            }

            const newCertificate = {
                id: 'cert-' + Date.now().toString().slice(-6),
                studentId: studentId,
                doctorId: currentUserId,
                reason: reason,
                startDate: startDate,
                endDate: endDate,
                issueDate: new Date().toISOString()
            };

            const medicalCertificates = getMedicalCertificates();
            medicalCertificates.push(newCertificate);
            saveMedicalCertificates(medicalCertificates);

            showModal(`Medical Certificate for ${studentId} generated successfully!`);
            this.reset();
            showSection('doctor-dashboard');
        });

        // --- Schedule Follow Up Logic (Doctor) ---
        document.getElementById('followUpIsVirtual').addEventListener('change', function () {
            const virtualFields = document.getElementById('followUpVirtualFields');
            if (this.checked) {
                virtualFields.classList.remove('hidden');
            } else {
                virtualFields.classList.add('hidden');
            }
        });

        function populateChronicPatientsDropdown() {
            const patientSelect = document.getElementById('followUpPatientId');
            patientSelect.innerHTML = '<option value="">-- Select Patient --</option>'; // Clear existing options
            const noPatientsMessage = document.getElementById('noChronicPatientsMessage');
            noPatientsMessage.classList.add('hidden');

            const chronicPatients = simulatedUsers.filter(u => u.role === 'Student' && u.chronicCondition);

            if (chronicPatients.length === 0) {
                noPatientsMessage.classList.remove('hidden');
                patientSelect.disabled = true;
                document.querySelector('#scheduleFollowUpForm button[type="submit"]').disabled = true;
                return;
            } else {
                patientSelect.disabled = false;
                document.querySelector('#scheduleFollowUpForm button[type="submit"]').disabled = false;
            }

            chronicPatients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.innerText = patient.name;
                patientSelect.appendChild(option);
            });
        }

        document.getElementById('scheduleFollowUpForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const patientId = document.getElementById('followUpPatientId').value;
            const dateTime = document.getElementById('followUpDateTime').value;
            const reason = document.getElementById('followUpReason').value;
            const isVirtual = document.getElementById('followUpIsVirtual').checked;
            const platform = isVirtual ? document.getElementById('followUpPlatform').value : '';

            if (!patientId || !dateTime || !reason) {
                showModal('Please fill in all required fields for the follow-up appointment.');
                return;
            }

            const newFollowUpAppointment = {
                id: 'app-' + Date.now().toString().slice(-6),
                studentId: patientId,
                appointmentDateTime: dateTime,
                reasonForVisit: reason,
                isVirtual: isVirtual,
                platform: platform,
                status: 'Scheduled', // Directly scheduled by doctor
                assignedStaff: `Dr. ${simulatedUsers.find(u => u.id === currentUserId).name.split(' ')[1]}`,
                assignedDoctorId: currentUserId,
                assignedNurseId: null,
                hasFeedback: false,
                isFollowUp: true, // Mark as follow-up
                reminders: [] // Reminders will be added by the system
            };

            const appointments = getAppointments();
            appointments.push(newFollowUpAppointment);
            saveAppointments(appointments);

            showModal(`Follow-up appointment scheduled for ${simulatedUsers.find(u => u.id === patientId).name} on ${new Date(dateTime).toLocaleString()}! Reminders will be sent automatically.`);
            this.reset();
            document.getElementById('followUpVirtualFields').classList.add('hidden');
            showSection('doctor-dashboard');
        });

        // --- Nurse Specific Logic ---

        function renderNurseAssignedAppointments() {
            const appointments = getAppointments().filter(app => app.assignedNurseId === currentUserId && app.status === 'Scheduled');
            const nurseAppointmentsListDiv = document.getElementById('nurse-appointments-list');
            nurseAppointmentsListDiv.innerHTML = '';

            if (appointments.length === 0) {
                nurseAppointmentsListDiv.innerHTML = '<p class="text-center text-gray-600 p-4">No scheduled appointments assigned to you.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="nurse-appointments-table-body">
                    </tbody>
                `;
            nurseAppointmentsListDiv.appendChild(table);
            const tbody = document.getElementById('nurse-appointments-table-body');

            appointments.forEach(app => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';

                const patient = simulatedUsers.find(u => u.id === app.studentId);
                const patientName = patient ? patient.name : app.studentId;

                const typeBadge = app.isVirtual ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">Virtual</span>' : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">In-Person</span>';

                row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(app.appointmentDateTime).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${patientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${app.reasonForVisit}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${typeBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="btn-success-sm" onclick="prepareNurseConsultation('${app.id}', '${app.studentId}', '${patientName}')">Start Intake</button>
                        </td>
                    `;
            });
        }

        function prepareNurseConsultation(appointmentId, patientId, patientName) {
            // Set hidden fields in the nurse consultation form
            document.getElementById('nurseConsultationAppointmentId').value = appointmentId;
            document.getElementById('nurseConsultationPatientId').value = patientId;
            document.getElementById('nurseConsultationPatientName').innerText = patientName;

            // Clear previous inputs
            document.getElementById('temperature').value = '';
            document.getElementById('bloodPressure').value = '';
            document.getElementById('heartRate').value = '';
            document.getElementById('oxygenSaturation').value = '';
            document.getElementById('nurseObservations').value = '';

            showSection('start-consultation-nurse');
        }

        document.getElementById('nurseConsultationForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const appointmentId = document.getElementById('nurseConsultationAppointmentId').value;
            const patientId = document.getElementById('nurseConsultationPatientId').value;
            const temperature = document.getElementById('temperature').value;
            const bloodPressure = document.getElementById('bloodPressure').value;
            const heartRate = document.getElementById('heartRate').value;
            const oxygenSaturation = document.getElementById('oxygenSaturation').value;
            const nurseObservations = document.getElementById('nurseObservations').value;

            const vitals = {
                temperature: temperature,
                bloodPressure: bloodPressure,
                heartRate: heartRate,
                oxygenSaturation: oxygenSaturation
            };

            // Save Medical History Entry (Nurse's part)
            const newMedicalHistoryEntry = {
                id: Date.now().toString(),
                patientId: patientId,
                nurseId: currentUserId, // Nurse ID
                timestamp: new Date().toISOString(),
                nurseNotes: nurseObservations, // Nurse's observations
                vitals: vitals,
                diagnosis: '', // Doctor will fill this
                notes: '', // Doctor will fill this
                prescribedMedications: [] // Doctor will fill this
            };
            const medicalHistoryEntries = getMedicalHistoryEntries();
            medicalHistoryEntries.push(newMedicalHistoryEntry);
            saveMedicalHistoryEntries(medicalHistoryEntries);

            // Optionally, update appointment status to indicate nurse intake is complete
            let appointments = getAppointments();
            const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);
            if (appointmentIndex > -1) {
                // For this prototype, we'll just show a modal and keep it 'Scheduled' for doctor
                // In a real system, you might change the status to 'NurseIntakeComplete' or similar
                // to indicate it's ready for the doctor.
                // appointments[appointmentIndex].status = 'NurseIntakeComplete';
                saveAppointments(appointments);
            }

            showModal('Patient intake completed by Nurse. Vitals and observations recorded.');
            this.reset();
            showSection('my-assigned-appointments-nurse'); // Go back to assigned appointments
        });

        // --- Receptionist Specific Logic ---

        function populateStaffDropdown(selectId, roles) {
            const selectElement = document.getElementById(selectId);
            selectElement.innerHTML = '<option value="">All Staff</option>'; // Default option
            simulatedUsers.filter(user => roles.includes(user.role)).forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.id;
                option.innerText = staff.name;
                selectElement.appendChild(option);
            });
        }

        function renderReceptionistAppointments() {
            const appointments = getAppointments();
            const receptionistAppointmentsListDiv = document.getElementById('receptionist-appointments-list');
            receptionistAppointmentsListDiv.innerHTML = '';

            if (appointments.length === 0) {
                receptionistAppointmentsListDiv.innerHTML = '<p class="text-center text-gray-600 p-4">No appointments found.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned Staff</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="receptionist-appointments-table-body">
                    </tbody>
                `;
            receptionistAppointmentsListDiv.appendChild(table);
            const tbody = document.getElementById('receptionist-appointments-table-body');

            appointments.sort((a, b) => new Date(a.appointmentDateTime) - new Date(b.appointmentDateTime)).forEach(app => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';

                const patient = simulatedUsers.find(u => u.id === app.studentId);
                const patientName = patient ? patient.name : app.studentId;

                let assignedStaffName = 'Not yet assigned';
                if (app.assignedDoctorId) {
                    const doctor = simulatedUsers.find(u => u.id === app.assignedDoctorId);
                    assignedStaffName = doctor ? `Dr. ${doctor.name.split(' ')[1]}` : 'Assigned Doctor';
                }
                if (app.assignedNurseId) {
                    const nurse = simulatedUsers.find(u => u.id === app.assignedNurseId);
                    assignedStaffName = nurse ? `Nurse ${nurse.name.split(' ')[1]}` : 'Assigned Nurse';
                }
                // If both are assigned, display both
                if (app.assignedDoctorId && app.assignedNurseId) {
                    const doctor = simulatedUsers.find(u => u.id === app.assignedDoctorId);
                    const nurse = simulatedUsers.find(u => u.id === app.assignedNurseId);
                    assignedStaffName = `${doctor ? `Dr. ${doctor.name.split(' ')[1]}` : ''}${doctor && nurse ? ' & ' : ''}${nurse ? `Nurse ${nurse.name.split(' ')[1]}` : ''}`;
                }


                const statusClasses = {
                    'Completed': 'bg-green-100 text-green-800',
                    'Scheduled': 'bg-blue-100 text-blue-800',
                    'PendingAssignment': 'bg-yellow-100 text-yellow-800',
                    'CancelledByClinic': 'bg-red-100 text-red-800',
                    'CancelledByStudent': 'bg-red-100 text-red-800'
                };
                const statusBadge = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClasses[app.status] || 'bg-gray-100 text-gray-800'}">${app.status}</span>`;

                let actionsHtml = '';
                if (app.status === 'PendingAssignment') {
                    actionsHtml += `<button class="btn-outline-blue-sm mr-2" onclick="openAssignStaffModal('${app.id}')">Assign Staff</button>`;
                }
                if (app.status === 'Scheduled' || app.status === 'PendingAssignment') {
                    actionsHtml += `<button class="btn-danger-sm" onclick="confirmCancelAppointment('${app.id}')">Cancel</button>`;
                } else {
                    actionsHtml += `<span class="text-gray-500">No actions</span>`;
                }


                row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${app.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(app.appointmentDateTime).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${patientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${app.reasonForVisit}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${assignedStaffName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${actionsHtml}</td>
                    `;
            });
        }

        function openAssignStaffModal(appointmentId) {
            document.getElementById('assignAppointmentId').value = appointmentId;
            document.getElementById('assignAppointmentDisplayId').innerText = appointmentId;

            const doctorSelect = document.getElementById('assignDoctorSelect');
            const nurseSelect = document.getElementById('assignNurseSelect');

            // Clear previous options
            doctorSelect.innerHTML = '<option value="">-- Select Doctor (Optional) --</option>';
            nurseSelect.innerHTML = '<option value="">-- Select Nurse (Optional) --</option>';

            // Populate doctors
            simulatedUsers.filter(u => u.role === 'Doctor').forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.id;
                option.innerText = doctor.name;
                doctorSelect.appendChild(option);
            });

            // Populate nurses
            simulatedUsers.filter(u => u.role === 'Nurse').forEach(nurse => {
                const option = document.createElement('option');
                option.value = nurse.id;
                option.innerText = nurse.name;
                nurseSelect.appendChild(option);
            });

            document.getElementById('assignStaffModal').style.display = 'flex';
        }

        function closeAssignStaffModal() {
            document.getElementById('assignStaffModal').style.display = 'none';
            document.getElementById('assignStaffForm').reset();
        }

        document.getElementById('assignStaffForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const appointmentId = document.getElementById('assignAppointmentId').value;
            const selectedDoctorId = document.getElementById('assignDoctorSelect').value;
            const selectedNurseId = document.getElementById('assignNurseSelect').value;

            if (!selectedDoctorId && !selectedNurseId) {
                showModal('Please select at least one staff member (Doctor or Nurse).');
                return;
            }

            let appointments = getAppointments();
            const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);

            if (appointmentIndex > -1) {
                const appointment = appointments[appointmentIndex];
                appointment.assignedDoctorId = selectedDoctorId || null;
                appointment.assignedNurseId = selectedNurseId || null;

                let assignedStaffNames = [];
                if (selectedDoctorId) {
                    const doctor = simulatedUsers.find(u => u.id === selectedDoctorId);
                    if (doctor) assignedStaffNames.push(doctor.name);
                }
                if (selectedNurseId) {
                    const nurse = simulatedUsers.find(u => u.id === selectedNurseId);
                    if (nurse) assignedStaffNames.push(nurse.name);
                }
                appointment.assignedStaff = assignedStaffNames.join(' and ') || 'Not yet assigned';

                appointment.status = 'Scheduled'; // Mark as scheduled once staff is assigned

                saveAppointments(appointments);
                showModal(`Staff assigned to appointment ${appointmentId} successfully!`);
                closeAssignStaffModal();
                renderReceptionistAppointments(); // Refresh the list
            } else {
                showModal('Appointment not found.');
            }
        });

        function confirmCancelAppointment(appointmentId) {
            // Using custom modal for confirmation
            document.getElementById('modalMessage').innerHTML = `Are you sure you want to cancel appointment <strong>${appointmentId}</strong>?`;
            document.getElementById('customModal').style.display = 'flex';
            // Change OK button to a "Yes, Cancel" and add a "No" button
            const okButton = document.querySelector('#customModal .mt-4');
            okButton.innerText = 'Yes, Cancel';
            okButton.onclick = function () {
                cancelAppointment(appointmentId);
                closeModal();
                // Restore original OK button text and function for future modals
                okButton.innerText = 'OK';
                okButton.onclick = closeModal;
            };
            const noButton = document.createElement('button');
            noButton.className = 'mt-4 ml-2 px-6 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400';
            noButton.innerText = 'No';
            noButton.onclick = function () {
                closeModal();
                // Restore original OK button text and function
                okButton.innerText = 'OK';
                okButton.onclick = closeModal;
                noButton.remove(); // Remove itself
            };
            okButton.parentNode.appendChild(noButton);
        }

        function cancelAppointment(appointmentId) {
            let appointments = getAppointments();
            const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);

            if (appointmentIndex > -1) {
                appointments[appointmentIndex].status = 'CancelledByClinic';
                saveAppointments(appointments);
                showModal(`Appointment ${appointmentId} has been cancelled.`);
                renderReceptionistAppointments(); // Refresh the list
            } else {
                showModal(`Appointment ${appointmentId} not found.`);
            }
        }

        // Create Appointment by Receptionist
        function populateStudentDropdown() {
            const studentSelect = document.getElementById('createAppStudentId');
            studentSelect.innerHTML = '<option value="">-- Select Student --</option>'; // Clear existing options
            simulatedUsers.filter(u => u.role === 'Student').forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.innerText = student.name;
                studentSelect.appendChild(option);
            });
        }

        document.getElementById('createAppIsVirtual').addEventListener('change', function () {
            const virtualFields = document.getElementById('createAppVirtualFields');
            if (this.checked) {
                virtualFields.classList.remove('hidden');
            } else {
                virtualFields.classList.add('hidden');
            }
        });

        document.getElementById('createAppointmentReceptionistForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const studentId = document.getElementById('createAppStudentId').value;
            const dateTime = document.getElementById('createAppDateTime').value;
            const reason = document.getElementById('createAppReason').value;
            const isVirtual = document.getElementById('createAppIsVirtual').checked;
            const platform = isVirtual ? document.getElementById('createAppPlatform').value : '';

            if (!studentId || !dateTime || !reason) {
                showModal('Please fill in all required fields for the appointment.');
                return;
            }

            const newAppointment = {
                id: 'app-' + Date.now().toString().slice(-6),
                studentId: studentId,
                appointmentDateTime: dateTime,
                reasonForVisit: reason,
                isVirtual: isVirtual,
                platform: platform,
                status: 'PendingAssignment', // Newly created appointments start as pending assignment
                assignedStaff: 'Not yet assigned',
                assignedDoctorId: null,
                assignedNurseId: null,
                hasFeedback: false,
                isFollowUp: false, // Not a follow-up by default
                reminders: [] // No reminders yet
            };

            const appointments = getAppointments();
            appointments.push(newAppointment);
            saveAppointments(appointments);

            showModal('New appointment created successfully! It is now pending staff assignment.');
            this.reset();
            document.getElementById('createAppVirtualFields').classList.add('hidden');
            showSection('manage-appointments-receptionist'); // Go back to manage appointments
        });

        // Feedback Report
        function renderFeedbackReport() {
            let feedbackEntries = getFeedback();
            const feedbackListDiv = document.getElementById('feedback-list');
            feedbackListDiv.innerHTML = '';

            // Apply filters
            const filterStaffId = document.getElementById('filterStaff').value;
            const filterStartDate = document.getElementById('filterStartDate').value;
            const filterEndDate = document.getElementById('filterEndDate').value;
            const filterMinRating = parseInt(document.getElementById('filterMinRating').value);
            const filterKeywords = document.getElementById('filterKeywords').value.toLowerCase();

            const filteredFeedback = feedbackEntries.filter(fdbk => {
                const feedbackDate = new Date(fdbk.timestamp);
                const matchesStaff = !filterStaffId || fdbk.assignedDoctorId === filterStaffId || fdbk.assignedNurseId === filterStaffId;
                const matchesStartDate = !filterStartDate || feedbackDate >= new Date(filterStartDate);
                const matchesEndDate = !filterEndDate || feedbackDate <= new Date(filterEndDate);
                const matchesRating = !filterMinRating || fdbk.rating >= filterMinRating;
                const matchesKeywords = !filterKeywords || fdbk.comments.toLowerCase().includes(filterKeywords) || fdbk.assignedStaffNames.some(name => name.toLowerCase().includes(filterKeywords));

                return matchesStaff && matchesStartDate && matchesEndDate && matchesRating && matchesKeywords;
            });


            if (filteredFeedback.length === 0) {
                feedbackListDiv.innerHTML = '<p class="text-center text-gray-600 p-4">No feedback found matching your filters.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Feedback ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Appointment ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Involved</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comments</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="feedback-table-body">
                    </tbody>
                `;
            feedbackListDiv.appendChild(table);
            const tbody = document.getElementById('feedback-table-body');

            filteredFeedback.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(fdbk => { // Sort by newest first
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${fdbk.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${fdbk.studentName} (${fdbk.studentId})</td>
                        <td class="px-6 py-4 whitespace-nowrap">${fdbk.appointmentId}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${fdbk.assignedStaffNames.join(', ') || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-normal">${fdbk.comments}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${fdbk.rating}/5</td>
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(fdbk.timestamp).toLocaleDateString()}</td>
                    `;
            });
        }

        function clearFeedbackFilters() {
            document.getElementById('filterStaff').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterMinRating').value = '';
            document.getElementById('filterKeywords').value = '';
            renderFeedbackReport(); // Re-render with cleared filters
        }

        function downloadFeedbackListPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Clinic Feedback List", 14, 20);

            const tableData = [];
            const headers = ["ID", "Student", "Appointment ID", "Staff Involved", "Comments", "Rating", "Date"];

            const feedbackTableBody = document.getElementById('feedback-table-body');
            if (feedbackTableBody) {
                Array.from(feedbackTableBody.rows).forEach(row => {
                    const rowData = [];
                    Array.from(row.cells).forEach(cell => {
                        rowData.push(cell.innerText);
                    });
                    tableData.push(rowData);
                });
            }

            doc.autoTable({
                startY: 30,
                head: [headers],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0] },
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    4: { cellWidth: 50 } // Adjust width for comments
                }
            });

            doc.save('feedback_list.pdf');
            showModal('Feedback list downloaded as PDF!');
        }

        // Survey Summary
        function renderSurveySummary() {
            let feedbackEntries = getFeedback();
            const summaryFilterStaffId = document.getElementById('summaryFilterStaff').value;
            const summaryFilterStartDate = document.getElementById('summaryFilterStartDate').value;
            const summaryFilterEndDate = document.getElementById('summaryFilterEndDate').value;

            const filteredFeedback = feedbackEntries.filter(fdbk => {
                const feedbackDate = new Date(fdbk.timestamp);
                const matchesStaff = !summaryFilterStaffId || fdbk.assignedDoctorId === summaryFilterStaffId || fdbk.assignedNurseId === summaryFilterStaffId;
                const matchesStartDate = !summaryFilterStartDate || feedbackDate >= new Date(summaryFilterStartDate);
                const matchesEndDate = !summaryFilterEndDate || feedbackDate <= new Date(summaryFilterEndDate);
                return matchesStaff && matchesStartDate && matchesEndDate;
            });

            const summaryContentDiv = document.getElementById('summary-content');
            summaryContentDiv.innerHTML = '';

            if (filteredFeedback.length === 0) {
                summaryContentDiv.innerHTML = '<p class="text-center text-gray-600 p-4">No summary data available for the selected filters.</p>';
                return;
            }

            // Calculate aggregate data
            const totalFeedback = filteredFeedback.length;
            const totalRatingSum = filteredFeedback.reduce((sum, fdbk) => sum + fdbk.rating, 0);
            const averageRating = totalFeedback > 0 ? (totalRatingSum / totalFeedback).toFixed(2) : 'N/A';

            const ratingCounts = { '1': 0, '2': 0, '3': 0, '4': 0, '5': 0 };
            filteredFeedback.forEach(fdbk => {
                ratingCounts[fdbk.rating]++;
            });

            let staffPerformance = {};
            filteredFeedback.forEach(fdbk => {
                let staffIds = [];
                if (fdbk.assignedDoctorId) staffIds.push(fdbk.assignedDoctorId);
                if (fdbk.assignedNurseId) staffIds.push(fdbk.assignedNurseId);

                staffIds.forEach(staffId => {
                    if (!staffPerformance[staffId]) {
                        staffPerformance[staffId] = { count: 0, sumRating: 0, name: simulatedUsers.find(u => u.id === staffId)?.name || 'Unknown' };
                    }
                    staffPerformance[staffId].count++;
                    staffPerformance[staffId].sumRating += fdbk.rating;
                });
            });

            let staffPerformanceHtml = '<h4 class="text-lg font-semibold mt-4 mb-2">Staff Performance Breakdown:</h4>';
            staffPerformanceHtml += '<ul class="list-disc list-inside ml-4">';
            for (const staffId in staffPerformance) {
                const data = staffPerformance[staffId];
                const avg = data.count > 0 ? (data.sumRating / data.count).toFixed(2) : 'N/A';
                staffPerformanceHtml += `<li><strong>${data.name}:</strong> Average Rating: ${avg} (from ${data.count} feedback)</li>`;
            }
            staffPerformanceHtml += '</ul>';


            summaryContentDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg shadow-sm">
                            <h4 class="text-md font-semibold text-blue-800">Total Feedback Entries:</h4>
                            <p class="text-2xl font-bold text-blue-700">${totalFeedback}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg shadow-sm">
                            <h4 class="text-md font-semibold text-green-800">Overall Average Rating:</h4>
                            <p class="text-2xl font-bold text-green-700">${averageRating}</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-gray-800 mb-4">Rating Distribution:</h3>
                    <table class="min-w-full divide-y divide-gray-200 mb-6">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${Object.keys(ratingCounts).map(rating => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">${rating} Star</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${ratingCounts[rating]}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${totalFeedback > 0 ? ((ratingCounts[rating] / totalFeedback) * 100).toFixed(1) : 0}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${staffPerformanceHtml}
                `;
        }

        function clearSummaryFilters() {
            document.getElementById('summaryFilterStaff').value = '';
            document.getElementById('summaryFilterStartDate').value = '';
            document.getElementById('summaryFilterEndDate').value = '';
            renderSurveySummary(); // Re-render with cleared filters
        }

        function downloadSummaryPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text("Clinic Survey Summary Report", 14, 20);

            const summaryContent = document.getElementById('summary-content').innerText;
            doc.setFontSize(10);
            doc.text(summaryContent, 14, 30, { maxWidth: 180 });

            doc.save('survey_summary.pdf');
            showModal('Survey summary downloaded as PDF!');
        }


        // --- System Reminder Logic (Simulated) ---
        function checkAndSendReminders() {
            let appointments = getAppointments();
            const now = new Date();

            appointments.forEach(app => {
                if (app.isFollowUp && app.status === 'Scheduled') {
                    const appDateTime = new Date(app.appointmentDateTime);
                    const timeUntilApp = appDateTime.getTime() - now.getTime(); // milliseconds

                    // 1 week reminder (7 days * 24 hours * 60 mins * 60 secs * 1000 ms)
                    const oneWeekMs = 7 * 24 * 60 * 60 * 1000;
                    // 2 days reminder
                    const twoDaysMs = 2 * 24 * 60 * 60 * 1000;
                    // On day reminder (within the last 24 hours before appointment)
                    const onDayMs = 24 * 60 * 60 * 1000;

                    // Check for 1-week reminder
                    if (timeUntilApp > oneWeekMs && !app.reminders.some(r => r.type === '1-week')) {
                        app.reminders.push({ dateSent: now.toISOString(), type: '1-week', status: 'Sent', responseType: null, responseDate: null });
                        console.log(`[REMINDER] Sent 1-week reminder for appointment ${app.id}`);
                    }
                    // Check for 2-day reminder
                    else if (timeUntilApp <= twoDaysMs && timeUntilApp > 0 && !app.reminders.some(r => r.type === '2-day')) {
                        app.reminders.push({ dateSent: now.toISOString(), type: '2-day', status: 'Sent', responseType: null, responseDate: null });
                        console.log(`[REMINDER] Sent 2-day reminder for appointment ${app.id}`);
                    }
                    // Check for on-day reminder
                    else if (timeUntilApp <= 0 && timeUntilApp > -onDayMs && !app.reminders.some(r => r.type === 'on-day')) {
                        app.reminders.push({ dateSent: now.toISOString(), type: 'on-day', status: 'Sent', responseType: null, responseDate: null });
                        console.log(`[REMINDER] Sent on-day reminder for appointment ${app.id}`);
                    }
                }
            });
            saveAppointments(appointments); // Save updated reminders
        }

        function acknowledgeReminder(appointmentId) {
            let appointments = getAppointments();
            const appointmentIndex = appointments.findIndex(app => app.id === appointmentId);

            if (appointmentIndex > -1) {
                const appointment = appointments[appointmentIndex];
                const lastReminder = appointment.reminders[appointment.reminders.length - 1]; // Get the most recent reminder

                if (lastReminder && !lastReminder.responseType) {
                    lastReminder.responseType = 'Acknowledged';
                    lastReminder.responseDate = new Date().toISOString();
                    saveAppointments(appointments);
                    showModal(`Reminder for appointment ${appointmentId} acknowledged!`);
                    renderAppointments('upcoming'); // Refresh student's appointments
                } else {
                    showModal('No pending reminder to acknowledge for this appointment.');
                }
            } else {
                showModal('Appointment not found.');
            }
        }


        // --- Role Selection Logic ---
        document.getElementById('userRoleSelect').addEventListener('change', function () {
            currentUserRole = this.value;
            // Simulate changing currentUserId based on role for chat
            if (currentUserRole === 'Student') {
                currentUserId = 'student-1';
            } else if (currentUserRole === 'Doctor') {
                currentUserId = 'doctor-1';
            } else if (currentUserRole === 'Pharmacist') {
                currentUserId = 'pharmacist-1';
            } else if (currentUserRole === 'Receptionist') {
                currentUserId = 'receptionist-1';
            } else if (currentUserRole === 'Nurse') {
                currentUserId = 'nurse-1';
            } else if (currentUserRole === 'Admin') {
                currentUserId = 'admin-1';
            }
            // <!-- NEW/MODIFIED SECTION -->
            else if (currentUserRole === 'DeliveryDriver') {
                currentUserId = 'driver-1';
            }
            // <!-- END NEW/MODIFIED SECTION -->
            else {
                currentUserId = 'guest-user';
            }
            updateNavigationVisibility(currentUserRole);
            // Re-render data based on new user/role
            if (currentUserRole === 'Student') {
                renderAppointments('upcoming');
                renderMyDeliveryRequests(); // Refresh delivery requests for student
                populateFeedbackAppointmentsDropdown(); // Refresh feedback dropdown
                prepareEmergencyRequest(); // Prepare emergency form for current student
            } else if (currentUserRole === 'Pharmacist') {
                renderMedications();
                renderPendingPrescriptions();
            } else if (currentUserRole === 'Doctor') {
                renderDoctorAssignedAppointments();
                populateChronicPatientsDropdown(); // Refresh chronic patients for doctor
            } else if (currentUserRole === 'Nurse') {
                renderNurseAssignedAppointments();
            } else if (currentUserRole === 'Receptionist') {
                renderReceptionistAppointments(); // Refresh receptionist's view
                populateStaffDropdown('filterStaff', ['Doctor', 'Nurse']); // Populate staff filter for feedback report
                populateStaffDropdown('summaryFilterStaff', ['Doctor', 'Nurse']); // Populate staff filter for summary
            }
            // <!-- NEW/MODIFIED SECTION -->
            else if (currentUserRole === 'DeliveryDriver') {
                renderDriverDeliveries();
            }
            // <!-- END NEW/MODIFIED SECTION -->
            renderContacts();
            document.getElementById('chatHeader').innerText = 'Select a contact to start messaging';
            document.getElementById('messagesArea').innerHTML = '';
            document.getElementById('sendButton').disabled = true;
            document.getElementById('messageInput').disabled = true;
            currentChatReceiverId = null; // Reset selected chat user
        });

        // --- Initial Data Seeding ---
        function seedInitialData() {
            // Seed initial medications if none exist
            if (getMedications().length === 0) {
                const initialMedications = [
                    { id: 'med-001', name: 'Paracetamol', dosage: '500mg', stockQuantity: 150, price: 15.00 },
                    { id: 'med-002', name: 'Amoxicillin', dosage: '250mg', stockQuantity: 80, price: 45.50 },
                    { id: 'med-003', name: 'Ibuprofen', dosage: '200mg', stockQuantity: 25, price: 12.75 }, // Set stock to 25
                    { id: 'med-004', name: 'Cough Syrup', dosage: '100ml', stockQuantity: 50, price: 30.00 },
                    { id: 'med-005', name: 'Antihistamine', dosage: '10mg', stockQuantity: 120, price: 25.00 }
                ];
                saveMedications(initialMedications);
            }

            // Seed initial prescriptions if none exist
            if (getPrescriptions().length === 0) {
                const initialPrescriptions = [
                    {
                        id: 'pres-001',
                        patientId: 'student-1',
                        doctorId: 'doctor-1',
                        medications: [
                            { name: 'Paracetamol', dosage: '500mg', quantity: 20 },
                            { name: 'Cough Syrup', dosage: '100ml', quantity: 1 }
                        ],
                        datePrescribed: new Date().toISOString(),
                        status: 'Pending',
                        pharmacistNotes: '',
                        isDeliveryRequested: false
                    },
                    {
                        id: 'pres-002',
                        patientId: 'student-2',
                        doctorId: 'doctor-1',
                        medications: [
                            { name: 'Amoxicillin', dosage: '250mg', quantity: 14 }
                        ],
                        datePrescribed: new Date(Date.now() - 86400000).toISOString(), // Yesterday
                        status: 'Ready for Collection', // This one can be requested for delivery
                        pharmacistNotes: 'Ready for pickup',
                        isDeliveryRequested: false
                    },
                    {
                        id: 'pres-003',
                        patientId: 'student-1', // Make this one for student-1 to test delivery
                        doctorId: 'doctor-1',
                        medications: [
                            { name: 'Ibuprofen', dosage: '200mg', quantity: 30 }
                        ],
                        datePrescribed: new Date(Date.now() - 2 * 86400000).toISOString(), // 2 days ago
                        status: 'Ready for Collection',
                        pharmacistNotes: 'Dispensed on 2025-08-04',
                        isDeliveryRequested: false // Make it available for delivery request
                    }
                ];
                savePrescriptions(initialPrescriptions);
            }

            // Seed initial appointments if none exist
            if (getAppointments().length === 0) {
                const initialAppointments = [
                    {
                        id: 'app-001',
                        studentId: 'student-1',
                        appointmentDateTime: new Date(Date.now() + 3600000).toISOString(), // 1 hour from now
                        reasonForVisit: 'Flu symptoms',
                        isVirtual: false,
                        platform: '',
                        status: 'Scheduled',
                        assignedStaff: 'Dr. Emily Doctor', // Display name
                        assignedDoctorId: 'doctor-1', // Actual ID
                        assignedNurseId: null,
                        hasFeedback: false,
                        isFollowUp: false,
                        reminders: []
                    },
                    {
                        id: 'app-002',
                        studentId: 'student-2',
                        appointmentDateTime: new Date(Date.now() + 7200000).toISOString(), // 2 hours from now
                        reasonForVisit: 'Follow-up on rash',
                        isVirtual: true,
                        platform: 'Zoom',
                        status: 'Scheduled',
                        assignedStaff: 'Dr. Emily Doctor',
                        assignedDoctorId: 'doctor-1',
                        assignedNurseId: null,
                        hasFeedback: false,
                        isFollowUp: false,
                        reminders: []
                    },
                    {
                        id: 'app-003',
                        studentId: 'student-1',
                        appointmentDateTime: new Date(Date.now() - 86400000).toISOString(), // Yesterday
                        reasonForVisit: 'Headache',
                        isVirtual: false,
                        platform: '',
                        status: 'Completed',
                        assignedStaff: 'Dr. Emily Doctor',
                        assignedDoctorId: 'doctor-1',
                        assignedNurseId: null,
                        hasFeedback: false, // This one is eligible for feedback
                        isFollowUp: false,
                        reminders: []
                    },
                    {
                        id: 'app-004',
                        studentId: 'student-2',
                        appointmentDateTime: new Date(Date.now() - 2 * 86400000).toISOString(), // 2 days ago
                        reasonForVisit: 'Routine checkup',
                        isVirtual: true,
                        platform: 'Teams',
                        status: 'Completed',
                        assignedStaff: 'Dr. Emily Doctor',
                        assignedDoctorId: 'doctor-1',
                        assignedNurseId: null,
                        hasFeedback: true, // Already has feedback
                        isFollowUp: false,
                        reminders: []
                    },
                    {
                        id: 'app-005', // New appointment for Nurse
                        studentId: 'student-1',
                        appointmentDateTime: new Date(Date.now() + 1800000).toISOString(), // 30 mins from now
                        reasonForVisit: 'Pre-doctor checkup (Nurse Intake)',
                        isVirtual: false,
                        platform: '',
                        status: 'Scheduled',
                        assignedStaff: 'Nurse Eve Nurse',
                        assignedDoctorId: 'doctor-1', // Assigned to a doctor for later, but nurse sees it first
                        assignedNurseId: 'nurse-1',
                        hasFeedback: false,
                        isFollowUp: false,
                        reminders: []
                    },
                    {
                        id: 'app-006', // New appointment for Receptionist to assign
                        studentId: 'student-3',
                        appointmentDateTime: new Date(Date.now() + 5400000).toISOString(), // 1.5 hours from now
                        reasonForVisit: 'General checkup',
                        isVirtual: false,
                        platform: '',
                        status: 'PendingAssignment',
                        assignedStaff: 'Not yet assigned',
                        assignedDoctorId: null,
                        assignedNurseId: null,
                        hasFeedback: false,
                        isFollowUp: false,
                        reminders: []
                    },
                    {
                        id: 'app-007', // Another for Receptionist to assign
                        studentId: 'student-1',
                        appointmentDateTime: new Date(Date.now() + 10800000).toISOString(), // 3 hours from now
                        reasonForVisit: 'Sore throat',
                        isVirtual: true,
                        platform: 'GoogleMeet',
                        status: 'PendingAssignment',
                        assignedStaff: 'Not yet assigned',
                        assignedDoctorId: null,
                        assignedNurseId: null,
                        hasFeedback: false,
                        isFollowUp: false,
                        reminders: []
                    },
                    {
                        id: 'app-008', // Follow-up appointment for student-1 (chronic)
                        studentId: 'student-1',
                        appointmentDateTime: new Date(Date.now() + (7 * 24 * 60 * 60 * 1000) + (1 * 60 * 60 * 1000)).toISOString(), // 7 days and 1 hour from now
                        reasonForVisit: 'Follow-up for hypertension',
                        isVirtual: false,
                        platform: '',
                        status: 'Scheduled',
                        assignedStaff: 'Dr. Emily Doctor',
                        assignedDoctorId: 'doctor-1',
                        assignedNurseId: null,
                        hasFeedback: false,
                        isFollowUp: true,
                        reminders: []
                    },
                    {
                        id: 'app-009', // Completed appointment for student-3, assigned to doctor-2
                        studentId: 'student-3',
                        appointmentDateTime: new Date(Date.now() - 3 * 86400000).toISOString(), // 3 days ago
                        reasonForVisit: 'Checkup for diabetes',
                        isVirtual: false,
                        platform: '',
                        status: 'Completed',
                        assignedStaff: 'Dr. David Doctor',
                        assignedDoctorId: 'doctor-2',
                        assignedNurseId: null,
                        hasFeedback: false, // Eligible for feedback
                        isFollowUp: false,
                        reminders: []
                    },
                    {
                        id: 'app-010', // Completed appointment for student-1, assigned to nurse-1
                        studentId: 'student-1',
                        appointmentDateTime: new Date(Date.now() - 4 * 86400000).toISOString(), // 4 days ago
                        reasonForVisit: 'Vaccination',
                        isVirtual: false,
                        platform: '',
                        status: 'Completed',
                        assignedStaff: 'Nurse Eve Nurse',
                        assignedDoctorId: null,
                        assignedNurseId: 'nurse-1',
                        hasFeedback: false, // Eligible for feedback
                        isFollowUp: false,
                        reminders: []
                    }
                ];
                saveAppointments(initialAppointments);
            }

            // Seed initial medical history entries if none exist
            if (getMedicalHistoryEntries().length === 0) {
                const initialMedicalHistory = [
                    {
                        id: 'hist-001',
                        patientId: 'student-1',
                        doctorId: 'doctor-1',
                        timestamp: new Date(Date.now() - 86400000).toISOString(),
                        notes: 'Patient presented with mild headache and fatigue. Advised rest and hydration.',
                        diagnosis: 'Common cold (mild)',
                        prescribedMedications: [],
                        nurseNotes: '', // Added for nurse data
                        vitals: null // Added for nurse data
                    },
                    {
                        id: 'hist-002',
                        patientId: 'student-2',
                        doctorId: 'doctor-1',
                        timestamp: new Date(Date.now() - 2 * 86400000).toISOString(),
                        notes: 'Routine checkup. Patient reports no major concerns. Vitals stable.',
                        diagnosis: 'Healthy',
                        prescribedMedications: [],
                        nurseNotes: '',
                        vitals: null
                    }
                ];
                saveMedicalHistoryEntries(initialMedicalHistory);
            }

            // Seed initial feedback if none exist
            if (getFeedback().length === 0) {
                const initialFeedback = [
                    {
                        id: 'fdbk-001',
                        appointmentId: 'app-004',
                        studentId: 'student-2',
                        studentName: 'Bob Student',
                        rating: 5,
                        comments: 'Excellent service, very efficient and friendly staff. Dr. Emily was great!',
                        timestamp: new Date(Date.now() - 1.5 * 86400000).toISOString(),
                        assignedDoctorId: 'doctor-1',
                        assignedNurseId: null,
                        assignedStaffNames: ['Dr. Emily Doctor']
                    },
                    {
                        id: 'fdbk-002',
                        appointmentId: 'app-009',
                        studentId: 'student-3',
                        studentName: 'Charlie Student',
                        rating: 4,
                        comments: 'Good overall experience, but wait time was a bit long.',
                        timestamp: new Date(Date.now() - 2.5 * 86400000).toISOString(),
                        assignedDoctorId: 'doctor-2',
                        assignedNurseId: null,
                        assignedStaffNames: ['Dr. David Doctor']
                    },
                    {
                        id: 'fdbk-003',
                        appointmentId: 'app-010',
                        studentId: 'student-1',
                        studentName: 'Alice Student',
                        rating: 5,
                        comments: 'Nurse Eve was very professional and gentle during the vaccination.',
                        timestamp: new Date(Date.now() - 3.5 * 86400000).toISOString(),
                        assignedDoctorId: null,
                        assignedNurseId: 'nurse-1',
                        assignedStaffNames: ['Nurse Eve Nurse']
                    }
                ];
                saveFeedback(initialFeedback);
            }

            // Seed initial delivery requests if none exist
            if (getDeliveryRequests().length === 0) {
                const initialDeliveryRequests = [
                    {
                        id: 'del-001',
                        studentId: 'student-1',
                        prescriptionId: 'pres-003', // This prescription is ready for collection
                        medicationsSummary: 'Ibuprofen (200mg) x30',
                        deliveryAddress: '123 Main St, Durban',
                        contactNumber: '0711234567',
                        requestDate: new Date(Date.now() - 1 * 86400000).toISOString(), // Requested yesterday
                        status: 'Dispatched', // Already dispatched
                        confirmationDate: null,
                        deliveryType: 'Other', // Example of a paid delivery
                        paymentStatus: 'Paid',
                        paymentAmount: 50.00,
                        otp: '123456' // <!-- NEW/MODIFIED SECTION -->
                    },
                    {
                        id: 'del-002',
                        studentId: 'student-2',
                        prescriptionId: 'pres-002', // This prescription is ready for collection
                        medicationsSummary: 'Amoxicillin (250mg) x14',
                        deliveryAddress: '456 Oak Ave, Berea',
                        contactNumber: '0609876543',
                        requestDate: new Date(Date.now() - 0.5 * 86400000).toISOString(), // Requested half a day ago
                        status: 'Pending', // Still pending
                        confirmationDate: null,
                        deliveryType: 'Other',
                        paymentStatus: 'Pending',
                        paymentAmount: 50.00,
                        otp: '789012' // <!-- NEW/MODIFIED SECTION -->
                    },
                    {
                        id: 'del-003',
                        studentId: 'student-1',
                        prescriptionId: 'pres-001',
                        medicationsSummary: 'Paracetamol (500mg) x20, Cough Syrup (100ml) x1',
                        deliveryAddress: 'Residence A',
                        contactNumber: '0821112222',
                        requestDate: new Date(Date.now() - 0.1 * 86400000).toISOString(),
                        status: 'Pending',
                        confirmationDate: null,
                        deliveryType: 'DUT',
                        paymentStatus: 'N/A',
                        paymentAmount: 0.00,
                        otp: '345678' // <!-- NEW/MODIFIED SECTION -->
                    }
                ];
                saveDeliveryRequests(initialDeliveryRequests);
            }

            // Seed initial ambulance requests if none exist
            if (getAmbulanceRequests().length === 0) {
                const initialAmbulanceRequests = [
                    {
                        id: 'amb-001',
                        studentId: 'student-1',
                        studentName: 'Alice Student',
                        location: 'DUT Residence A, Room 305',
                        emergencyDescription: 'Severe allergic reaction, difficulty breathing.',
                        requestTime: new Date(Date.now() - 1 * 3600000).toISOString(), // 1 hour ago
                        status: 'Dispatched'
                    }
                ];
                saveAmbulanceRequests(initialAmbulanceRequests);
            }

            // Seed initial emergency notifications if none exist
            if (getEmergencyNotifications().length === 0) {
                const initialEmergencyNotifications = [
                    {
                        id: 'notif-001',
                        requestId: 'amb-001',
                        patientId: 'student-1',
                        contactName: 'John Doe',
                        contactMethod: 'SMS to 0821112222',
                        message: 'URGENT: An ambulance has been dispatched for Alice Student due to an emergency. Location: DUT Residence A, Room 305. Please contact them for more details.',
                        timestamp: new Date(Date.now() - 1 * 3600000).toISOString(),
                        status: 'Sent'
                    }
                ];
                saveEmergencyNotifications(initialEmergencyNotifications);
            }

            // Seed DUT Residences if none exist
            if (getDutResidences().length === 0) {
                saveDutResidences(dutResidences);
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', function () {
            seedInitialData(); // Populate localStorage with initial data
            checkAndSendReminders(); // Run reminder check on load

            // Initialize navigation and content based on default role
            updateNavigationVisibility(document.getElementById('userRoleSelect').value);
            // Re-render data based on initial user/role
            if (document.getElementById('userRoleSelect').value === 'Student') {
                renderAppointments('upcoming');
                renderMyDeliveryRequests(); // Initial render for student delivery requests
                populateFeedbackAppointmentsDropdown(); // Initial render for feedback dropdown
                prepareEmergencyRequest(); // Prepare emergency form for current student
            } else if (document.getElementById('userRoleSelect').value === 'Pharmacist') {
                renderMedications();
                renderPendingPrescriptions();
            } else if (document.getElementById('userRoleSelect').value === 'Doctor') {
                renderDoctorAssignedAppointments();
                populateChronicPatientsDropdown(); // Initial render for doctor's chronic patients
            } else if (document.getElementById('userRoleSelect').value === 'Nurse') {
                renderNurseAssignedAppointments();
            } else if (currentUserRole === 'Receptionist') {
                renderReceptionistAppointments();
                populateStaffDropdown('filterStaff', ['Doctor', 'Nurse']); // Populate staff filter for feedback report
                populateStaffDropdown('summaryFilterStaff', ['Doctor', 'Nurse']); // Populate staff filter for summary
            }
            renderContacts();
            document.getElementById('chatHeader').innerText = 'Select a contact to start messaging';
            document.getElementById('messagesArea').innerHTML = '';
            document.getElementById('sendButton').disabled = true;
            document.getElementById('messageInput').disabled = true;
            currentChatReceiverId = null; // Reset selected chat user
        });
    </script>
</body>
</html>
